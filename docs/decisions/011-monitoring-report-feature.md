# ADR 011: 監視レポート自動生成機能

## ステータス

**Implemented** ✅

- ReportGenerator クラス実装済み
- `agent report` コマンド実装済み
- CLI完了時の自動生成フック実装済み

## コンテキスト

オーケストレーション完走後に監視レポートを自動生成したい。現在は手動でCLIログを解析してレポートを作成している。レポートには以下の情報を含める：

- 監視期間（開始〜終了時刻）
- タスク統計（総数、完了、失敗、スキップ、ブロック）
- タスク実行サマリー
- 観察されたイベント（コンフリクト、リトライなど）

## 検討したアプローチ

| アプローチ | 評価 |
|-----------|------|
| A. オーケストレーター内蔵 | ❌ Core層肥大化、関心の分離に反する |
| B. CLIラッパー（tee） | ❌ ログ形式依存、パース複雑 |
| C. ポストプロセス（agent report） | △ 柔軟だが手動実行が必要 |
| D. ハイブリッド | ✅ C + 自動呼び出しフックで柔軟性と自動化を両立 |

## 決定

**ハイブリッド方式（D）を採用**

### 設計判断

| 項目 | 決定 | 理由 |
|------|------|------|
| 保存先 | `agent-coord/reports/{rootSessionId}.md` | オーケストレーター専用領域 |
| 集計単位 | rootSessionId連鎖 | agent continueを含めた一連の実行を1レポートに |
| 収集範囲 | 全セッション（失敗含む） | 完全な履歴を保持 |
| 出力形式 | Markdownファイル | 人間可読性を優先 |
| 生成タイミング | 成功・失敗両方 | デバッグ情報として有用 |
| 再生成方針 | 上書き | シンプルな実装を優先 |
| エラー時 | 警告のみで続行 | レポート失敗でコマンド全体を失敗させない |

### 実装構成

1. **レポート生成モジュール**: `src/core/report/`
2. **CLIコマンド**: `agent report [rootSessionId]`
3. **自動生成フック**: CLI層（run.ts, continue.ts）で統合

### データ取得

- `listSessionsByRootId()`: rootSessionIdから連鎖内の全セッションを取得
- `getTasksByRootSession()`: 既存のヘルパー関数を活用
- タスク状態から直接イベントを検出（ログ解析なし）

## 根拠

- **関心の分離**: Core層（orchestrate.ts）の変更を最小限に
- **既存パターン準拠**: 既存のrootSessionId/parentSessionId構造を活用
- **柔軟性**: 手動でも自動でもレポート生成可能
- **テスタビリティ**: report-generatorは純粋関数として実装

## Future対応（別フェーズ）

- 並行性制御（レポート生成のロック機構）
- ログ解析によるイベント検出（LOG_TRUNCATION, RATE_LIMIT）
- JSON形式での出力
- 中間レポート生成

## 結果

- rootSessionId連鎖でセッションを追跡し、統合レポートを生成
- 各CLI完了時に自動生成、手動でも再生成可能
- 構造化データのみを使用し、ログ解析は将来拡張
