# ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆå›å¾©å‡¦ç†ã®ä¿®æ­£è¨ˆç”»

## æ¦‚è¦

ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆç™ºç”Ÿæ™‚ã®è‡ªå‹•å›å¾©å‡¦ç†ãŒå®Ÿéš›ã®ã‚±ãƒ¼ã‚¹ã§å‹•ä½œã—ã¦ã„ãªã„å•é¡Œã‚’ä¿®æ­£ã™ã‚‹ã€‚

## èƒŒæ™¯ã¨å‹•æ©Ÿ

### ç™ºç”Ÿã—ãŸå•é¡Œ

å®Ÿéš›ã®é‹ç”¨ãƒ­ã‚°ï¼ˆ`.tmp/tmp.log`ï¼‰ã«ãŠã„ã¦ã€ä»¥ä¸‹ã®å•é¡ŒãŒç¢ºèªã•ã‚ŒãŸï¼š

```
âŒ [task-8deb848f-5] Task execution failed: Git command failed: merge feature/screenshot-task-8deb848f-3 (exit code -1)
CONFLICT (content): Merge conflict in node_modules/.bin/esbuild
CONFLICT (content): Merge conflict in pnpm-lock.yaml
```

### æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ

1. ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæ¤œå‡º â†’ `MergeResult { hasConflicts: true }` ã‚’è¿”ã™
2. ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«åˆ¤å®š â†’ è‡ªå‹•è§£æ±ºä¸å¯ã‚’æ¤œå‡º
3. ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆ â†’ LLMã«è§£æ±ºã‚’ä¾é ¼
4. è§£æ±ºå¾Œæ¤œè¨¼ â†’ ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒãƒ¼ã‚«ãƒ¼æ®‹å­˜ãƒã‚§ãƒƒã‚¯

### å®Ÿéš›ã®å‹•ä½œ

1. `git merge` å¤±æ•—æ™‚ã« `GitResponseError` ä»¥å¤–ã®ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦æ‰±ã‚ã‚Œã¦ã„ã‚‹
2. ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯ã«åˆ°é”ã—ã¦ã„ãªã„
3. å³åº§ã« `createErr` ãŒè¿”ã•ã‚Œã€ã‚¿ã‚¹ã‚¯ãŒå¤±æ•—æ‰±ã„

## å•é¡Œåˆ†æ

### Issue 1: simple-gitã®ã‚¨ãƒ©ãƒ¼å‹åˆ¤å®šã®å¤±æ•—

**å ´æ‰€**: `src/adapters/vcs/simple-git-effects.ts:210-238`

**ç¾åœ¨ã®å®Ÿè£…**:
```typescript
} catch (err) {
  if (err instanceof GitResponseError) {  // â† ã“ã“ã§falseã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§
    const status = await git.status();
    if (status.conflicted.length > 0) {
      return createOk({ success: false, hasConflicts: true, ... });
    }
  }
  return createErr(gitError);  // â† ã“ã“ã«åˆ°é”ã—ã¦ã—ã¾ã†
}
```

**åŸå› ã®ä»®èª¬**:
- simple-gitãŒè¿”ã™ã‚¨ãƒ©ãƒ¼ãŒ `GitResponseError` ã§ã¯ãªãåˆ¥ã®å‹
- ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ãƒã‚§ãƒ¼ãƒ³ã®å•é¡Œ
- ã¾ãŸã¯ `status.conflicted` å–å¾—æ™‚ã«ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ

### Issue 2: ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«åˆ¤å®šã®ä¸ååˆ†ã•

**å ´æ‰€**: `src/core/orchestrator/worker-operations.ts:262-300`

**ç¾åœ¨ã®å®Ÿè£…**:
```typescript
const binaryExtensions = ['.png', '.jpg', '.exe', ...];
const ext = path.extname(filePath).toLowerCase();
return binaryExtensions.includes(ext);
```

**å•é¡Œç‚¹**:
| ãƒ•ã‚¡ã‚¤ãƒ« | æ‹¡å¼µå­ | åˆ¤å®šçµæœ | å®Ÿéš› |
|---------|--------|---------|------|
| `node_modules/.bin/esbuild` | ãªã— | ãƒ†ã‚­ã‚¹ãƒˆ | ãƒã‚¤ãƒŠãƒª/ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ |
| `pnpm-lock.yaml` | `.yaml` | ãƒ†ã‚­ã‚¹ãƒˆ | è‡ªå‹•ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ« |
| `node_modules/.pnpm/lock.yaml` | `.yaml` | ãƒ†ã‚­ã‚¹ãƒˆ | è‡ªå‹•ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ« |

### Issue 3: è‡ªå‹•ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã®è€ƒæ…®ä¸è¶³

`node_modules/` é…ä¸‹ã‚„ `pnpm-lock.yaml` ã¯ï¼š
- å„worktreeã§ `pnpm install` ã™ã‚‹ãŸã³ã«ç•°ãªã‚‹å†…å®¹ã«ãªã‚‹
- LLMã«ã‚ˆã‚‹è‡ªå‹•è§£æ±ºãŒä¸é©åˆ‡
- æœ¬æ¥ã¯ `.gitignore` ã«å…¥ã‚Œã‚‹ã‹ã€ç‰¹åˆ¥ãªå‡¦ç†ãŒå¿…è¦

## ä¿®æ­£è¨ˆç”»

### Phase 1: ã‚¨ãƒ©ãƒ¼å‹åˆ¤å®šã®æ”¹å–„ï¼ˆå„ªå…ˆåº¦: é«˜ï¼‰

**ç›®æ¨™**: ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæ™‚ã«ç¢ºå®Ÿã« `hasConflicts: true` ã‚’è¿”ã™

**ä¿®æ­£å†…å®¹**:

```typescript
// src/adapters/vcs/simple-git-effects.ts

const merge: GitEffects['merge'] = async (path, sourceBranch, options) => {
  const git = simpleGit(path);

  try {
    await git.merge([sourceBranch, ...(options || [])]);
    // æˆåŠŸæ™‚ã®å‡¦ç†ï¼ˆå¤‰æ›´ãªã—ï¼‰
  } catch (err) {
    // æ”¹å–„: ã‚¨ãƒ©ãƒ¼å‹ã«é–¢ä¿‚ãªãã€ã¾ãšstatusã‚’ç¢ºèª
    try {
      const status = await git.status();

      if (status.conflicted.length > 0) {
        // ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒç™ºç”Ÿã—ã¦ã„ã‚‹
        const conflicts: GitConflictInfo[] = status.conflicted.map((filePath) => ({
          reason: 'merge conflict',
          filePath,
          type: 'content' as const,
        }));

        return createOk({
          success: false,
          mergedFiles: [],
          hasConflicts: true,
          conflicts,
          status: 'conflicts',
        });
      }
    } catch (statusErr) {
      // statuså–å¾—å¤±æ•—æ™‚ã®ãƒ­ã‚°å‡ºåŠ›
      console.error('Failed to get git status after merge error:', statusErr);
    }

    // ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦æ‰±ã†
    const gitError = toGitError(`merge ${sourceBranch}`)(err);
    return createErr(gitError);
  }
};
```

**å¤‰æ›´ç‚¹**:
- `err instanceof GitResponseError` ã®æ¡ä»¶ã‚’å‰Šé™¤
- ã©ã‚“ãªã‚¨ãƒ©ãƒ¼å‹ã§ã‚‚ã€ã¾ãš `git status` ã‚’ç¢ºèª
- statuså–å¾—å¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’è¿½åŠ 

### Phase 2: è‡ªå‹•ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã®é™¤å¤–ï¼ˆå„ªå…ˆåº¦: é«˜ï¼‰

**ç›®æ¨™**: `node_modules/` ã‚„ lockãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’è‡ªå‹•è§£æ±ºå¯¾è±¡ã‹ã‚‰é™¤å¤–

**ä¿®æ­£å†…å®¹**:

```typescript
// src/core/orchestrator/worker-operations.ts

// æ–°è¦è¿½åŠ : è‡ªå‹•ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ¤å®š
const isAutoGeneratedFile = (filePath: string): boolean => {
  const autoGeneratedPatterns = [
    // ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ãƒ•ã‚¡ã‚¤ãƒ«
    /^node_modules\//,
    /^\.pnpm\//,
    /pnpm-lock\.yaml$/,
    /package-lock\.json$/,
    /yarn\.lock$/,
    // ãƒ“ãƒ«ãƒ‰å‡ºåŠ›
    /^dist\//,
    /^build\//,
    /^\.next\//,
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    /^\.cache\//,
    /^\.turbo\//,
  ];

  return autoGeneratedPatterns.some(pattern => pattern.test(filePath));
};

// isBinaryFile ã‚’æ‹¡å¼µ
const shouldSkipAutoResolution = (filePath: string): { skip: boolean; reason: string } => {
  // è‡ªå‹•ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«
  if (isAutoGeneratedFile(filePath)) {
    return { skip: true, reason: 'auto-generated file' };
  }

  // ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæ—¢å­˜ã®åˆ¤å®šï¼‰
  if (isBinaryFile(filePath)) {
    return { skip: true, reason: 'binary file' };
  }

  // æ‹¡å¼µå­ãªã—ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆnode_modules/.bin/* ãªã©ï¼‰
  const ext = path.extname(filePath);
  if (ext === '' && filePath.includes('/.bin/')) {
    return { skip: true, reason: 'executable without extension' };
  }

  return { skip: false, reason: '' };
};
```

### Phase 3: è‡ªå‹•ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºæˆ¦ç•¥ï¼ˆå„ªå…ˆåº¦: ä¸­ï¼‰

**ç›®æ¨™**: `pnpm-lock.yaml` ãªã©ã‚’è‡ªå‹•è§£æ±ºå¯èƒ½ã«ã™ã‚‹

**æˆ¦ç•¥**:

1. **lockãƒ•ã‚¡ã‚¤ãƒ«**: ãƒãƒ¼ã‚¸å¾Œã« `pnpm install` ã‚’å†å®Ÿè¡Œã—ã¦å†ç”Ÿæˆ
2. **node_modules/**: `.gitignore` ã«è¿½åŠ ã‚’æ¨å¥¨ + `pnpm install` ã§å†ç”Ÿæˆ

**ä¿®æ­£å†…å®¹**:

```typescript
// src/core/orchestrator/worker-operations.ts

const resolveLockfileConflict = async (
  worktreePath: WorktreePath,
  filePath: string,
  gitEffects: GitEffects
): Promise<Result<void, Error>> => {
  // 1. ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆçŠ¶æ…‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ—¦å‰Šé™¤ï¼ˆ--ours or --theirs ã¯ä½¿ã‚ãªã„ï¼‰
  await gitEffects.raw(worktreePath, ['checkout', '--ours', filePath]);
  await gitEffects.add(worktreePath, [filePath]);

  // 2. ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§å†ç”Ÿæˆ
  // Note: ã“ã®æ™‚ç‚¹ã§ã¯ã¾ã ã‚³ãƒŸãƒƒãƒˆã—ãªã„
  return createOk(undefined);
};

const resolveNodeModulesConflict = async (
  worktreePath: WorktreePath,
  conflictedFiles: string[],
  gitEffects: GitEffects
): Promise<Result<void, Error>> => {
  // node_modulesé…ä¸‹ã®ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã¯å…¨ã¦å‰Šé™¤ã—ã¦å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  for (const filePath of conflictedFiles) {
    // --ours ã‚’æ¡ç”¨ï¼ˆã©ã¡ã‚‰ã§ã‚‚è‰¯ã„ã€å¾Œã§å†ç”Ÿæˆã•ã‚Œã‚‹ï¼‰
    await gitEffects.raw(worktreePath, ['checkout', '--ours', filePath]);
    await gitEffects.add(worktreePath, [filePath]);
  }

  return createOk(undefined);
};
```

### Phase 4: ãƒãƒ¼ã‚¸å¾Œã®è‡ªå‹•å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆå„ªå…ˆåº¦: ä¸­ï¼‰

**ç›®æ¨™**: lockãƒ•ã‚¡ã‚¤ãƒ«ã‚„node_modulesã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºå¾Œã«ä¾å­˜é–¢ä¿‚ã‚’å†æ§‹ç¯‰

**ä¿®æ­£å†…å®¹**:

```typescript
// src/core/orchestrator/worker-operations.ts

// setupWorktreeWithMerge ã®ä¿®æ­£
if (merge.hasConflicts) {
  const lockfileConflicts = merge.conflicts.filter(c =>
    c.filePath.endsWith('pnpm-lock.yaml') ||
    c.filePath.endsWith('package-lock.json')
  );

  const nodeModulesConflicts = merge.conflicts.filter(c =>
    c.filePath.startsWith('node_modules/')
  );

  const otherConflicts = merge.conflicts.filter(c =>
    !lockfileConflicts.includes(c) && !nodeModulesConflicts.includes(c)
  );

  // 1. lockfile/node_modulesã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’è‡ªå‹•è§£æ±º
  if (lockfileConflicts.length > 0 || nodeModulesConflicts.length > 0) {
    console.log(`  ğŸ”§ Auto-resolving ${lockfileConflicts.length + nodeModulesConflicts.length} generated file conflicts`);

    for (const conflict of [...lockfileConflicts, ...nodeModulesConflicts]) {
      await gitEffects.raw(worktreePath, ['checkout', '--ours', conflict.filePath]);
      await gitEffects.add(worktreePath, [conflict.filePath]);
    }

    // ä¾å­˜é–¢ä¿‚ã®å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¿…è¦
    needsReinstall = true;
  }

  // 2. ãã®ä»–ã®ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã¯LLMã§è§£æ±ºï¼ˆæ—¢å­˜å‡¦ç†ï¼‰
  if (otherConflicts.length > 0) {
    // æ—¢å­˜ã®LLMè§£æ±ºå‡¦ç†
  }

  // 3. ã‚³ãƒŸãƒƒãƒˆ
  await gitEffects.commit(worktreePath, 'Resolve merge conflicts');

  // 4. ä¾å­˜é–¢ä¿‚ã®å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆå¿…è¦ãªå ´åˆï¼‰
  if (needsReinstall) {
    console.log(`  ğŸ“¦ Reinstalling dependencies...`);
    const installResult = await runCommand(worktreePath, 'pnpm', ['install']);
    if (!installResult.ok) {
      console.log(`  âš ï¸  Failed to reinstall dependencies: ${installResult.err}`);
    }
  }
}
```

### Phase 5: æ¨å¥¨äº‹é …ã®è­¦å‘Šå‡ºåŠ›ï¼ˆå„ªå…ˆåº¦: ä½ï¼‰

**ç›®æ¨™**: `node_modules/` ãŒgitç®¡ç†ã•ã‚Œã¦ã„ã‚‹å ´åˆã«è­¦å‘Šã‚’å‡ºã™

```typescript
// src/core/orchestrator/orchestrate.ts

const checkGitignoreRecommendations = async (repoPath: RepoPath): Promise<void> => {
  const gitignorePath = path.join(repoPath, '.gitignore');

  try {
    const content = await fs.readFile(gitignorePath, 'utf-8');
    const hasNodeModules = content.split('\n').some(line =>
      line.trim() === 'node_modules' || line.trim() === 'node_modules/'
    );

    if (!hasNodeModules) {
      console.log('  âš ï¸  Warning: node_modules/ is not in .gitignore');
      console.log('      This may cause merge conflicts in parallel execution.');
      console.log('      Recommendation: Add "node_modules/" to .gitignore');
    }
  } catch {
    // .gitignore ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç„¡è¦–
  }
};
```

## å®Ÿè£…é †åº

| Phase | å†…å®¹ | å„ªå…ˆåº¦ | å·¥æ•°ç›®å®‰ |
|-------|------|--------|---------|
| 1 | ã‚¨ãƒ©ãƒ¼å‹åˆ¤å®šã®æ”¹å–„ | é«˜ | å° |
| 2 | è‡ªå‹•ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã®é™¤å¤– | é«˜ | å° |
| 3 | lockfile/node_modulesã®è‡ªå‹•è§£æ±º | ä¸­ | ä¸­ |
| 4 | ãƒãƒ¼ã‚¸å¾Œã®è‡ªå‹•å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« | ä¸­ | ä¸­ |
| 5 | æ¨å¥¨äº‹é …ã®è­¦å‘Šå‡ºåŠ› | ä½ | å° |

## ãƒ†ã‚¹ãƒˆè¨ˆç”»

### ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

1. **simple-git-effects.ts**
   - ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæ™‚ã« `hasConflicts: true` ãŒè¿”ã‚‹ã“ã¨
   - æ§˜ã€…ãªã‚¨ãƒ©ãƒ¼å‹ã§ã‚‚æ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨

2. **worker-operations.ts**
   - `isAutoGeneratedFile` ã®åˆ¤å®šãŒæ­£ã—ã„ã“ã¨
   - `shouldSkipAutoResolution` ã®åˆ¤å®šãŒæ­£ã—ã„ã“ã¨

### E2Eãƒ†ã‚¹ãƒˆ

1. **ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚·ãƒŠãƒªã‚ª**
   - `node_modules/` ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆ â†’ è‡ªå‹•è§£æ±º â†’ æˆåŠŸ
   - `pnpm-lock.yaml` ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆ â†’ è‡ªå‹•è§£æ±º â†’ å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« â†’ æˆåŠŸ
   - ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆ â†’ LLMè§£æ±º â†’ æˆåŠŸ

## ãƒªã‚¹ã‚¯ã¨è€ƒæ…®äº‹é …

### ãƒªã‚¹ã‚¯

1. **`--ours` é¸æŠã«ã‚ˆã‚‹ä¾å­˜é–¢ä¿‚ã®ä¸æ•´åˆ**
   - ç·©å’Œç­–: å¿…ãš `pnpm install` ã‚’å†å®Ÿè¡Œ

2. **LLMè§£æ±ºã®ç²¾åº¦**
   - ç·©å’Œç­–: ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒãƒ¼ã‚«ãƒ¼æ®‹å­˜ãƒã‚§ãƒƒã‚¯ã®ç¶™ç¶š

3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**
   - `pnpm install` ã®è¿½åŠ å®Ÿè¡Œã«ã‚ˆã‚‹ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰
   - ç·©å’Œç­–: å¿…è¦ãªå ´åˆã®ã¿å®Ÿè¡Œ

### ä»£æ›¿æ¡ˆ

1. **node_modulesã‚’gitç®¡ç†ã—ãªã„é‹ç”¨ã¸ã®ç§»è¡Œã‚’å¼·åˆ¶**
   - Pros: æ ¹æœ¬è§£æ±º
   - Cons: æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸ã®å½±éŸ¿å¤§

2. **ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆç™ºç”Ÿæ™‚ã¯æ‰‹å‹•ä»‹å…¥ã‚’å¿…é ˆã¨ã™ã‚‹**
   - Pros: å®Ÿè£…ã‚·ãƒ³ãƒ—ãƒ«
   - Cons: è‡ªå‹•åŒ–ã®ç›®çš„ã«åã™ã‚‹

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [BlockReasonå‹å®šç¾©](./incomplete-task-retry.md#1-blockedç†ç”±ã®ç´°åˆ†åŒ–)
- [CASå®Ÿè£…](../decisions/001-cas-implementation-approach.md)
