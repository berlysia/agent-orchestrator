# 統合処理のコンフリクト回復機能追加計画

## 背景

worker-operations.ts では a61c802 で以下のコンフリクト回復機能が実装済み：
- node_modules/pnpm-lock.yaml のコンフリクトを `--ours` で自動解決
- コミット失敗時にマージを中断してエラーを返す
- node_modules/ が .gitignore にない場合に警告

しかし、integration-operations.ts（統合ワークツリーでのマージ処理）には同様の対応がなく、以下の問題が発生している。

## 発生している問題

### 問題1: 統合ワークツリーでのnode_modules自動解決がない

**ログ例（行146-199）:**
```
CONFLICT (content): Merge conflict in node_modules/.bin/esbuild
CONFLICT (content): Merge conflict in pnpm-lock.yaml
```

**原因:**
`mergeTasksInWorktree` 関数ではコンフリクト発生時に `abortMerge` を呼ぶだけで、worker-operations.ts にあるような自動解決ロジックがない。

**該当コード:** `integration-operations.ts:125-142`

### 問題2: マージエラー時の状態リセット不足

**ログ例（行275-279）:**
```
error: Merging is not possible because you have unmerged files.
hint: Fix them up in the work tree, and then use 'git add/rm <file>'
```

**原因:**
`isErr(mergeResult)` の場合、`abortMerge` を呼ばずに `continue` しているため、マージ状態が残ったまま次のマージを試行している。

**該当コード:** `integration-operations.ts:105-120`

### 問題3: ワークツリーパス構築エラー

**ログ例（行450-451）:**
```
fatal: '/home/.../browser-screenshot-to-discord/.git/worktree/home/.../integration-1769011339986' is not a working tree
```

**原因:**
パスが二重に連結されている。ワークツリー削除時のパス構築ロジックに問題がある。

## 修正方針

### Phase 1: マージエラー時の状態リセット追加

**対象:** `integration-operations.ts:105-120`

**変更内容:**
- `isErr(mergeResult)` の場合も `abortMerge` を呼ぶ
- エラー状態でもマージ状態をクリーンにしてから次のタスクに進む

```typescript
// Before
if (isErr(mergeResult)) {
  conflictedTaskIds.push(task.id);
  // ... mergeDetails追加
  continue;  // abortMergeなしで次へ
}

// After
if (isErr(mergeResult)) {
  // マージ状態をクリーンにする
  await gitEffects.abortMerge(repo);
  conflictedTaskIds.push(task.id);
  // ... mergeDetails追加
  continue;
}
```

### Phase 2: 統合ワークツリーでのnode_modules自動解決

**対象:** `integration-operations.ts:125-142`

**変更内容:**
worker-operations.ts の `shouldSkipAutoResolution` と自動解決ロジックを共通化し、統合処理でも使用する。

1. worker-operations.ts から以下の関数をエクスポート：
   - `isAutoGeneratedFile`
   - `isBinaryFile`
   - `shouldSkipAutoResolution`

2. integration-operations.ts のコンフリクト処理に自動解決ロジックを追加：
   - コンフリクトファイルをカテゴリ分類
   - lockfile/node_modules は `--ours` で自動解決
   - バイナリファイルはエラー
   - テキストファイルのみ conflictResolutionTask に委任

### Phase 3: ワークツリーパス構築の修正

**対象:** ワークツリー削除処理（orchestrate.ts または関連箇所）

**調査内容:**
- パスが二重連結される原因を特定
- 適切なパス構築に修正

## 実装順序

1. Phase 1（マージエラー時の状態リセット）- 影響範囲が小さく、即効性がある
2. Phase 2（node_modules自動解決）- メインの問題解決
3. Phase 3（パス構築修正）- 独立した問題

## テスト方針

- 既存のE2Eテストが通ることを確認
- 型チェック（pnpm typecheck）が通ることを確認

## 受け入れ条件

1. [x] `isErr(mergeResult)` 時に `abortMerge` が呼ばれる
2. [x] 統合ワークツリーでnode_modules/lockfileコンフリクトが自動解決される
3. [x] バイナリファイルコンフリクトは適切にエラーになる
4. [x] テキストファイルコンフリクトのみconflictResolutionTaskに委任される
5. [x] ワークツリー削除時のパスが正しく構築される
6. [x] 型チェックがエラーなく通る
7. [ ] E2Eテストが通る（未実行）

## 実装完了: 2026-01-22

### 変更ファイル
- `src/core/orchestrator/integration-operations.ts`
  - Phase 1: マージエラー時の `abortMerge` 追加（2箇所）
  - Phase 2: node_modules/lockfile の自動解決ロジック追加（2箇所）
  - Phase 3: ワークツリー削除時に `basename` でworktree名を抽出
