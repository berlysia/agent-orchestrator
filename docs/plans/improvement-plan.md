# Agent Orchestrator - æ”¹å–„è¨ˆç”»

**ä½œæˆæ—¥**: 2026-01-19
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: Phase 1-3 å®Œäº†ã€Phase 2.4 ä¿®æ­£ä¸­ã€Phase 4 ã¯åˆ¥Epicã€**Phase 5ä»¥é™ï¼ˆæ–°è¦è¦³ç‚¹ï¼‰è¿½åŠ **
**æ›´æ–°æ—¥**: 2026-01-19 (Phase 5ä»¥é™ã®æ–°è¦è¦³ç‚¹ã‚’è¿½åŠ )
**é–¢é€£**: [current-issues.md](./current-issues.md)

## å®Ÿè£…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

| Phase | å„ªå…ˆåº¦ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | å®Œäº†æ—¥ | ã‚³ãƒŸãƒƒãƒˆ |
|-------|--------|-----------|--------|----------|
| Phase 1: Workerå®Ÿè¡Œãƒ­ã‚°ã®ä¿å­˜ | é«˜ | âœ… å®Œäº† | 2026-01-19 | 73e74cc |
| Phase 2: Plannerã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆçµ±åˆ | ä¸­ | âš ï¸ ãƒã‚°ã‚ã‚Š | 2026-01-19 | 73e74cc |
| **Phase 2.4: runClaudeAgentãƒã‚°ä¿®æ­£** | ğŸ”´ ç·Šæ€¥ | ğŸš§ ä¿®æ­£ä¸­ | - | - |
| Phase 3: CLIå‡ºåŠ›ã®æ”¹å–„ | ä¸­ | âœ… å®Œäº† | 2026-01-19 | 73e74cc |
| Phase 4: Judgeåˆ¤å®šã®å¼·åŒ– | ä½ | ğŸ”œ åˆ¥Epic | - | - |

**å®Ÿè£…é †åº**: Phase 1 â†’ Phase 3 â†’ Phase 2 â†’ **Phase 2.4ï¼ˆç·Šæ€¥ãƒã‚°ä¿®æ­£ï¼‰**

### Phase 5ä»¥é™ï¼ˆæ–°è¦è¦³ç‚¹ï¼‰

| Phase | å„ªå…ˆåº¦ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | æ¨å®šå·¥æ•° | å®Œäº†æ—¥ | ã‚³ãƒŸãƒƒãƒˆ |
|-------|--------|-----------|----------|--------|----------|
| Phase 5.9: ãƒ¢ãƒ‡ãƒ«ã®ä½¿ã„åˆ†ã‘ | ä½ | âœ… å®Œäº† | 2-3æ™‚é–“ | 2026-01-19 | 95114c4 |
| Phase 5.1: ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã®å“è³ªå‘ä¸Š | é«˜ | âœ… å®Œäº† | 4-6æ™‚é–“ | 2026-01-19 | ab6fcea, 2a4f003 |
| Phase 5.2: ã‚¸ãƒ£ãƒƒã‚¸ã«ã‚ˆã‚‹ã‚¿ã‚¹ã‚¯å“è³ªè©•ä¾¡ | é«˜ | âœ… å®Œäº† | 6-8æ™‚é–“ | 2026-01-19 | 546f55d |
| Phase 5.3: ä¸¦åˆ—å®Ÿè¡Œã‚µãƒãƒ¼ãƒˆ | é«˜ | âœ… å®Œäº† | 10-12æ™‚é–“ | 2026-01-19 | 5a9870d |
| Phase 5.4: ç›´åˆ—ã‚¿ã‚¹ã‚¯ã®å¤‰æ›´çµ±åˆ | ä¸­ | âœ… å®Œäº† | 6-8æ™‚é–“ | 2026-01-19 | 6c19086 |
| Phase 5.5: çµ±åˆå‡¦ç†ã¨ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±º | ä¸­ | âœ… å®Œäº† | 11-12æ™‚é–“ | 2026-01-19 | - |
| Phase 5.6: ã‚¸ãƒ£ãƒƒã‚¸åˆ¤å®šã®é«˜åº¦åŒ– | ä¸­ | ğŸ“‹ è¨ˆç”»ä¸­ | 4-6æ™‚é–“ | - | - |
| Phase 5.7: å…¨ä½“å®Œäº†åˆ¤å®š | ä¸­ | ğŸ“‹ è¨ˆç”»ä¸­ | 4-6æ™‚é–“ | - | - |
| Phase 5.8: ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã®ç¶™ç¶šæ€§ | ä½ | ğŸ“‹ è¨ˆç”»ä¸­ | 4-6æ™‚é–“ | - | - |

**æ¨å¥¨å®Ÿè£…é †åº**: Phase 5.9 â†’ Phase 5.1 â†’ Phase 5.2 â†’ Phase 5.3 â†’ Phase 5.4 â†’ Phase 5.5 â†’ Phase 5.6 â†’ Phase 5.7 â†’ Phase 5.8

**Phase 5.1å®Œäº†**: ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ãŒç”Ÿæˆã™ã‚‹ã‚¿ã‚¹ã‚¯ã®å“è³ªã‚’å¤§å¹…ã«å‘ä¸Š

**æˆæœ**:
- âœ… Workerå®Ÿè¡Œãƒ­ã‚°ãŒ`runs/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«è‡ªå‹•ä¿å­˜ã•ã‚Œã‚‹
- âš ï¸ PlannerãŒå®Ÿéš›ã«Claude/Codexã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦ã‚¿ã‚¹ã‚¯åˆ†è§£ã‚’å®Ÿè¡Œï¼ˆãŸã ã—`runClaudeAgent`ã«ãƒã‚°ï¼‰
- âœ… CLIå®Ÿè¡Œæ™‚ã«ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé€”ä¸­çµŒéã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸ
- âœ… ãƒ‡ãƒãƒƒã‚°ã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒå®¹æ˜“ã«ãªã£ãŸ
- âœ… **Phase 5.9å®Œäº†**: å½¹å‰²åˆ¥ãƒ¢ãƒ‡ãƒ«æœ€é©åŒ–ï¼ˆPlanner=Opus, Worker=Sonnet, Judge=Haikuï¼‰ã«ã‚ˆã‚‹ã‚³ã‚¹ãƒˆå‰Šæ¸›ã¨åŠ¹ç‡åŒ–
  - Configæ§‹é€ ã‚’ `agents.{planner,worker,judge}` ã«åˆ·æ–°
  - å„å½¹å‰²ã”ã¨ã« `type` (claude/codex) ã¨ `model` ã‚’ã‚»ãƒƒãƒˆã§æŒ‡å®šå¯èƒ½
  - Zod 4ã® `toJSONSchema()` ã§ JSON ã‚¹ã‚­ãƒ¼ãƒã‚’è‡ªå‹•ç”Ÿæˆ
  - `??` ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¼”ç®—å­ã‚’å‰Šé™¤ã—ã€Config ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨
- âœ… **Phase 5.1å®Œäº†**: ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ãŒç”Ÿæˆã™ã‚‹ã‚¿ã‚¹ã‚¯ã®å“è³ªã‚’å¤§å¹…ã«å‘ä¸Š
  - TaskBreakdownå‹ã«Zodã‚¹ã‚­ãƒ¼ãƒï¼ˆv2ï¼‰ã‚’å°å…¥ã—ã€type/estimatedDuration/contextãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å¿…é ˆåŒ–
  - Taskå‹ã«taskTypeã¨contextãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã—ã¦æ°¸ç¶šåŒ–
  - buildPlanningPromptã‚’å¤§å¹…æ”¹å–„ï¼ˆã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—ã€ç²’åº¦ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã€å®Œå…¨ãªacceptance/contextè¦æ±‚ï¼‰
  - parseAgentOutputã‚’Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§å³æ ¼åŒ–ã—ã€ä¸æ­£ãªã‚¿ã‚¹ã‚¯ã‚’æ˜ç¢ºã«æ‹’å¦
  - ãƒ€ãƒŸãƒ¼ã‚¿ã‚¹ã‚¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å‰Šé™¤ã—ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå¤±æ•—æ™‚ã¯ã‚¨ãƒ©ãƒ¼çµ‚äº†
  - acceptanceã¨contextã«å®Œå…¨ãªå®Ÿè£…æƒ…å ±ã‚’è¦æ±‚ï¼ˆå¤–éƒ¨å‚ç…§ãªã—ã§å®Ÿè¡Œå¯èƒ½ã«ï¼‰

**ãƒ†ã‚¹ãƒˆ**: 23/23ãƒ†ã‚¹ãƒˆãŒæˆåŠŸï¼ˆPhase 5.1ã®Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€estimatedDurationç¯„å›²æ¤œè¨¼ã€TaskType enumæ¤œè¨¼ã‚’å«ã‚€ï¼‰

**ğŸ”´ ç™ºè¦‹ã•ã‚ŒãŸå•é¡Œ**:
- Phase 2å®Ÿè£…å¾Œã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã§`runClaudeAgent`ã®ãƒã‚°ã‚’ç™ºè¦‹
- ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯æ­£ã—ãå‹•ä½œã—ã¦ã„ã‚‹ãŒã€SDKã®æˆ»ã‚Šå€¤ã‚’èª¤ã£ã¦å‡¦ç†ã—ã¦ã„ã‚‹
- è©³ç´°ã¯ [current-issues.md#å•é¡Œ4](./current-issues.md#4-runclaudeagentã®å®Ÿè£…ãƒã‚°--ç·Šæ€¥) ã‚’å‚ç…§

## ç›®æ¨™

Agent Orchestratorã®å®Ÿè¡Œå¯è¦–æ€§ã‚’å‘ä¸Šã•ã›ã€æœ¬æ¥ã®ä¾¡å€¤ã‚’ç™ºæ®ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

## æ”¹å–„ãƒ•ã‚§ãƒ¼ã‚º

### Phase 1: Workerå®Ÿè¡Œãƒ­ã‚°ã®ä¿å­˜ ã€å„ªå…ˆåº¦: é«˜ã€‘

#### ç›®çš„
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé€”ä¸­çµŒéã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
- ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’å¯èƒ½ã«ã™ã‚‹
- å®Ÿè¡Œå±¥æ­´ã‚’è¿½è·¡å¯èƒ½ã«ã™ã‚‹

#### å¤‰æ›´å†…å®¹

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/core/orchestrator/worker-operations.ts`

##### 1.1 executeTaské–¢æ•°ã®ä¿®æ­£

**ç¾åœ¨**:
```typescript
const executeTask = async (
  task: Task,
  worktreePath: WorktreePath,
  agentType: AgentType,
): Promise<Result<WorkerResult, OrchestratorError>> => {
  const agentPrompt = `Execute task: ${task.acceptance}`;
  const agentResult = /* ... */;

  if (isErr(agentResult)) {
    return createOk({
      runId: `error-${task.id}`,
      success: false,
      error: agentResult.err.message,
    });
  }

  return createOk({
    runId: task.id,
    success: true,
  });
};
```

**å¤‰æ›´å¾Œ**:
```typescript
const executeTask = async (
  task: Task,
  worktreePath: WorktreePath,
  agentType: AgentType,
): Promise<Result<WorkerResult, OrchestratorError>> => {
  // 1. runsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¢ºä¿
  const ensureResult = await deps.runnerEffects.ensureRunsDir();
  if (isErr(ensureResult)) {
    return createErr(ensureResult.err);
  }

  // 2. RunIDç”Ÿæˆï¼ˆã‚¿ã‚¹ã‚¯IDãƒ™ãƒ¼ã‚¹ï¼‰
  const runId = `run-${task.id}-${Date.now()}`;

  // 3. å®Ÿè¡Œãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
  const runMetadata: Run = {
    id: runId,
    taskId: task.id,
    agentType,
    startedAt: new Date().toISOString(),
    status: 'running',
  };

  // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä¿å­˜
  const saveMetaResult = await deps.runnerEffects.saveRunMetadata(runMetadata);
  if (isErr(saveMetaResult)) {
    return createErr(saveMetaResult.err);
  }

  // 4. ãƒ­ã‚°ã«ã‚¿ã‚¹ã‚¯é–‹å§‹ã‚’è¨˜éŒ²
  await deps.runnerEffects.appendLog(
    runId,
    `[${new Date().toISOString()}] Starting task: ${task.acceptance}\n`
  );
  await deps.runnerEffects.appendLog(
    runId,
    `Agent Type: ${agentType}\n`
  );
  await deps.runnerEffects.appendLog(
    runId,
    `Worktree: ${worktreePath}\n\n`
  );

  // 5. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè¡Œ
  const agentPrompt = `Execute task: ${task.acceptance}`;
  const agentResult =
    agentType === 'claude'
      ? await deps.runnerEffects.runClaudeAgent(
          agentPrompt,
          worktreePath as string,
          'claude-sonnet-4-5-20250929',
        )
      : await deps.runnerEffects.runCodexAgent(agentPrompt, worktreePath as string);

  // 6. çµæœã‚’ãƒ­ã‚°ã«è¨˜éŒ²
  if (isErr(agentResult)) {
    const errorMsg = agentResult.err.message;
    await deps.runnerEffects.appendLog(
      runId,
      `[${new Date().toISOString()}] âŒ Agent execution failed\n`
    );
    await deps.runnerEffects.appendLog(runId, `Error: ${errorMsg}\n`);

    // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ›´æ–°
    const updatedMeta: Run = {
      ...runMetadata,
      status: 'failed',
      completedAt: new Date().toISOString(),
      error: errorMsg,
    };
    await deps.runnerEffects.saveRunMetadata(updatedMeta);

    return createOk({
      runId,
      success: false,
      error: errorMsg,
    });
  }

  // 7. æˆåŠŸæ™‚ã®å‡¦ç†
  const output = agentResult.val;
  await deps.runnerEffects.appendLog(
    runId,
    `[${new Date().toISOString()}] âœ… Agent execution completed\n`
  );
  await deps.runnerEffects.appendLog(
    runId,
    `Final Response:\n${output.finalResponse}\n`
  );

  // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ›´æ–°
  const completedMeta: Run = {
    ...runMetadata,
    status: 'completed',
    completedAt: new Date().toISOString(),
    output: output.finalResponse,
  };
  await deps.runnerEffects.saveRunMetadata(completedMeta);

  return createOk({
    runId,
    success: true,
  });
};
```

##### 1.2 å¿…è¦ãªå‹å®šç¾©ã®è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/types/run.ts` (æ—¢å­˜ã®å‹ã‚’ç¢ºèªãƒ»æ‹¡å¼µ)

```typescript
export interface Run {
  id: string;
  taskId: string;
  agentType: 'claude' | 'codex';
  startedAt: string;
  completedAt?: string;
  status: 'running' | 'completed' | 'failed';
  output?: string;
  error?: string;
}
```

#### å®Ÿè£…æ‰‹é †

1. `src/types/run.ts` ã®å‹å®šç¾©ã‚’ç¢ºèªãƒ»å¿…è¦ã«å¿œã˜ã¦æ‹¡å¼µ
2. `src/core/orchestrator/worker-operations.ts` ã® `executeTask` ã‚’ä¿®æ­£
3. ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦æ—¢å­˜æ©Ÿèƒ½ãŒå£Šã‚Œã¦ã„ãªã„ã‹ç¢ºèª
4. å®Ÿéš›ã« `agent run` ã‚’å®Ÿè¡Œã—ã¦ãƒ­ã‚°ãŒä¿å­˜ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
   ```bash
   agent run "ãƒ†ã‚¹ãƒˆç”¨ã‚¿ã‚¹ã‚¯"
   ls -la ~/workspace/agent-orchestorator-coord/runs/
   cat ~/workspace/agent-orchestorator-coord/runs/run-*.log
   ```

#### æˆåŠŸåŸºæº–

- âœ… runsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« `.log` ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã‚‹
- âœ… runsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« `.json` ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼‰ãŒä½œæˆã•ã‚Œã‚‹
- âœ… ãƒ­ã‚°ã«ã‚¿ã‚¹ã‚¯é–‹å§‹ãƒ»å®Œäº†ãƒ»ã‚¨ãƒ©ãƒ¼ãŒè¨˜éŒ²ã•ã‚Œã‚‹
- âœ… ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å‡ºåŠ›ãŒè¨˜éŒ²ã•ã‚Œã‚‹
- âœ… æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦ãƒ‘ã‚¹ã™ã‚‹

#### æ¨å®šå·¥æ•°
2-3æ™‚é–“

---

### Phase 2: Plannerã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆçµ±åˆ ã€å„ªå…ˆåº¦: ä¸­ã€‘

#### ç›®çš„
- ãƒ€ãƒŸãƒ¼å®Ÿè£…ã‚’ç½®ãæ›ãˆã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡ç¤ºã‹ã‚‰é©åˆ‡ã«ã‚¿ã‚¹ã‚¯åˆ†è§£ã‚’è¡Œã†
- è¤‡é›‘ãªæŒ‡ç¤ºã«å¯¾å¿œå¯èƒ½ã«ã™ã‚‹

#### å¤‰æ›´å†…å®¹

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/core/orchestrator/planner-operations.ts`

##### 2.1 planTasksé–¢æ•°ã®ä¿®æ­£

**ç¾åœ¨**:
```typescript
const planTasks = async (
  userInstruction: string,
): Promise<Result<PlanningResult, TaskStoreError>> => {
  // TODO: å®Ÿéš›ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œã‚’çµ±åˆ
  const taskBreakdowns = createDummyTaskBreakdown(userInstruction);
  // ...
};
```

**å¤‰æ›´å¾Œ**:
```typescript
const planTasks = async (
  userInstruction: string,
): Promise<Result<PlanningResult, TaskStoreError>> => {
  const plannerTaskId = `planner-${randomUUID()}`;

  // 1. Plannerãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
  const planningPrompt = buildPlanningPrompt(userInstruction);

  // 2. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè¡Œï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯Claudeï¼‰
  const runResult = await deps.runnerEffects.runClaudeAgent(
    planningPrompt,
    deps.appRepoPath,
    'claude-sonnet-4-5-20250929',
  );

  if (isErr(runResult)) {
    return createErr(
      ioError('planTasks', `Failed to run planner agent: ${runResult.err.message}`)
    );
  }

  // 3. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‡ºåŠ›ã‚’ãƒ‘ãƒ¼ã‚¹
  const taskBreakdowns = parseAgentOutput(runResult.val.finalResponse);

  if (taskBreakdowns.length === 0) {
    return createErr(
      ioError('planTasks', 'Agent returned no task breakdowns')
    );
  }

  // 4. ã‚¿ã‚¹ã‚¯ã‚’TaskStoreã«ä¿å­˜ï¼ˆæ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
  // ...
};
```

##### 2.2 ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ“ãƒ«ãƒ€ãƒ¼ã®å®Ÿè£…

```typescript
export const buildPlanningPrompt = (userInstruction: string): string => {
  return `You are a task planner for a multi-agent development system.

USER INSTRUCTION:
${userInstruction}

Your task is to break down this instruction into concrete, implementable tasks.

For each task, provide:
1. description: Clear description of what needs to be done
2. branch: Git branch name (e.g., "feature/add-login")
3. scopePaths: Array of file/directory paths that will be modified (e.g., ["src/auth/", "tests/auth/"])
4. acceptance: Acceptance criteria for completion

Output format (JSON array):
[
  {
    "description": "Task description",
    "branch": "feature/branch-name",
    "scopePaths": ["path1/", "path2/"],
    "acceptance": "Acceptance criteria"
  }
]

Rules:
- Create 1-5 tasks (prefer smaller, focused tasks)
- Each task should be independently implementable
- Branch names must be valid Git branch names
- Scope paths should be specific but allow flexibility
- Acceptance criteria should be testable

Output only the JSON array, no additional text.`;
};
```

##### 2.3 å‡ºåŠ›ãƒ‘ãƒ¼ã‚µãƒ¼ã®å®Ÿè£…

```typescript
export const parseAgentOutput = (output: string): TaskBreakdown[] => {
  try {
    // JSONãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠ½å‡ºï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã«å›²ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ï¼‰
    const jsonMatch = output.match(/```(?:json)?\s*\n?([\s\S]*?)\n?```/) ||
                      output.match(/(\[[\s\S]*\])/);

    const jsonStr = jsonMatch ? jsonMatch[1] : output;
    const parsed = JSON.parse(jsonStr.trim());

    if (!Array.isArray(parsed)) {
      console.warn('Agent output is not an array, wrapping in array');
      return [parsed];
    }

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    return parsed.filter((item) => {
      return (
        typeof item.description === 'string' &&
        typeof item.branch === 'string' &&
        Array.isArray(item.scopePaths) &&
        typeof item.acceptance === 'string'
      );
    });
  } catch (error) {
    console.error('Failed to parse agent output:', error);
    console.error('Output was:', output);
    return [];
  }
};
```

#### å®Ÿè£…æ‰‹é †

1. `buildPlanningPrompt` é–¢æ•°ã‚’å®Ÿè£…
2. `parseAgentOutput` é–¢æ•°ã‚’å®Ÿè£…
3. `planTasks` é–¢æ•°ã‚’ä¿®æ­£ã—ã¦ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™
4. ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ï¼ˆãƒ‘ãƒ¼ã‚µãƒ¼ã®ãƒ†ã‚¹ãƒˆï¼‰
5. å®Ÿéš›ã« `agent run` ã‚’å®Ÿè¡Œã—ã¦è¤‡æ•°ã‚¿ã‚¹ã‚¯ãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
6. `createDummyTaskBreakdown` ã‚’å‰Šé™¤ï¼ˆã¾ãŸã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã«æ®‹ã™ï¼‰

#### æˆåŠŸåŸºæº–

- âœ… ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã‚¿ã‚¹ã‚¯åˆ†è§£ã‚’å®Ÿè¡Œã™ã‚‹
- âœ… JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæ­£ã—ããƒ‘ãƒ¼ã‚¹ã•ã‚Œã‚‹
- âœ… è¤‡æ•°ã®ã‚¿ã‚¹ã‚¯ãŒç”Ÿæˆã•ã‚Œã‚‹ï¼ˆæŒ‡ç¤ºã«å¿œã˜ã¦ï¼‰
- âœ… ç”Ÿæˆã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ãŒTaskStoreã«ä¿å­˜ã•ã‚Œã‚‹
- âœ… ãƒ‘ãƒ¼ã‚µãƒ¼ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹

#### æ¨å®šå·¥æ•°
4-6æ™‚é–“

---

### Phase 2.4: runClaudeAgentãƒã‚°ä¿®æ­£ ã€å„ªå…ˆåº¦: ğŸ”´ ç·Šæ€¥ã€‘

#### ç™ºè¦‹ã®çµŒç·¯
Phase 2å®Ÿè£…å¾Œã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«ã€ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿï¼š

```
Failed to parse agent output: SyntaxError: Unexpected token '\', "\n[\n  {\n"... is not valid JSON
Output was: {"type":"result","subtype":"success",...,"result":"```json\n[...]```"}
```

#### æ ¹æœ¬åŸå› 
`src/core/runner/runner-effects-impl.ts:121`ã§ã€Claude Agent SDKã®æˆ»ã‚Šå€¤å…¨ä½“ã‚’`JSON.stringify`ã—ã¦ã—ã¾ã£ã¦ã„ã‚‹ã€‚

**ç¾åœ¨ã®èª¤ã£ãŸå®Ÿè£…**:
```typescript
// src/core/runner/runner-effects-impl.ts:102-126
const runClaudeAgent = async (
  prompt: string,
  _workingDirectory: string,
  model: string,
): Promise<Result<AgentOutput, RunnerError>> => {
  const result = await tryCatchIntoResultAsync(async () => {
    const { unstable_v2_prompt } = await import('@anthropic-ai/claude-agent-sdk');

    const sdkResult = await unstable_v2_prompt(prompt, {
      model: model || 'claude-sonnet-4-5-20250929',
    });

    // âŒ å•é¡Œ: sdkResultå…¨ä½“ã‚’JSONåŒ–ã—ã¦ã„ã‚‹
    return {
      finalResponse: JSON.stringify(sdkResult), // â† ã“ã®è¡ŒãŒé–“é•ã„
    } satisfies AgentOutput;
  });

  return mapErrForResult(result, (e) => agentExecutionError('claude', e));
};
```

**SDKã®å®Ÿéš›ã®æˆ»ã‚Šå€¤æ§‹é€ **:
```typescript
{
  type: "result",
  subtype: "success",
  is_error: false,
  duration_ms: 87833,
  duration_api_ms: 110675,
  num_turns: 6,
  result: "```json\n[...]```"  // â† ã“ã‚ŒãŒå®Ÿéš›ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”
}
```

#### ä¿®æ­£å†…å®¹

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/core/runner/runner-effects-impl.ts`

**ä¿®æ­£å‰**:
```typescript
return {
  finalResponse: JSON.stringify(sdkResult),
} satisfies AgentOutput;
```

**ä¿®æ­£å¾Œ**:
```typescript
return {
  finalResponse: sdkResult.result, // resultãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç›´æ¥ä½¿ç”¨
} satisfies AgentOutput;
```

#### å®Ÿè£…æ‰‹é †

1. `src/core/runner/runner-effects-impl.ts` ã®121è¡Œç›®ã‚’ä¿®æ­£
2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰ (`pnpm build`)
3. æ—¢å­˜ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ (`pnpm test`)
4. å®Ÿéš›ã«`agent run`ã‚’å®Ÿè¡Œã—ã¦è¤‡æ•°ã‚¿ã‚¹ã‚¯ãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
   ```bash
   agent run "GitHubçµ±åˆã®è«¸æ©Ÿèƒ½ã‚’è¨ˆç”»ã—ã¦æ–‡æ›¸åŒ–ã—ã¦ã€‚"
   # è¤‡æ•°ã®ã‚¿ã‚¹ã‚¯ãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
   ```

#### æˆåŠŸåŸºæº–

- âœ… `parseAgentOutput`ãŒã‚¨ãƒ©ãƒ¼ãªããƒ‘ãƒ¼ã‚¹ã§ãã‚‹
- âœ… ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒç”Ÿæˆã—ãŸè¤‡æ•°ã®ã‚¿ã‚¹ã‚¯ãŒæ­£ã—ãTaskStoreã«ä¿å­˜ã•ã‚Œã‚‹
- âœ… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ãƒ€ãƒŸãƒ¼ã‚¿ã‚¹ã‚¯ãŒä½¿ç”¨ã•ã‚Œãªã„
- âœ… æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦ãƒ‘ã‚¹ã™ã‚‹

#### å½±éŸ¿ç¯„å›²

**ä¿®æ­£ç®‡æ‰€**: 1ãƒ•ã‚¡ã‚¤ãƒ«ã€1è¡Œã®ã¿
**å½±éŸ¿**: Plannerï¼ˆã‚¿ã‚¹ã‚¯åˆ†è§£ï¼‰ã®å‹•ä½œãŒæ­£å¸¸åŒ–

#### æ¨å®šå·¥æ•°
30åˆ†ï¼ˆå®Ÿè£…5åˆ†ã€ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼25åˆ†ï¼‰

---

### Phase 3: CLIå‡ºåŠ›ã®æ”¹å–„ ã€å„ªå…ˆåº¦: ä¸­ã€‘

#### ç›®çš„
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§é€²æ—ã‚’è¡¨ç¤º
- å®Ÿè¡Œçµæœã®ç¢ºèªæ–¹æ³•ã‚’æä¾›
- ã‚ˆã‚Šè‰¯ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’å®Ÿç¾

#### å¤‰æ›´å†…å®¹

##### 3.1 orchestrate.tsã§ã®ãƒ­ã‚°å‡ºåŠ›æ”¹å–„

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/core/orchestrator/orchestrate.ts`

```typescript
// Workerå®Ÿè¡Œå¾Œã«ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’è¡¨ç¤º
console.log(`  ğŸ“ Execution log: runs/${runId}.log`);
console.log(`  ğŸ“Š Metadata: runs/${runId}.json`);
```

##### 3.2 agent statusã‚³ãƒãƒ³ãƒ‰ã®æ‹¡å¼µ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/cli/commands/status.ts`

```typescript
// æœ€è¿‘ã®å®Ÿè¡Œãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½ã‚’è¿½åŠ 
// ä¾‹: agent status --logs
// ä¾‹: agent status --task <task-id>
```

##### 3.3 æ–°ã—ã„ã‚³ãƒãƒ³ãƒ‰: agent logs

```typescript
// ç‰¹å®šã®å®Ÿè¡Œãƒ­ã‚°ã‚’è¡¨ç¤º
// agent logs <run-id>
// agent logs --task <task-id>  # ã‚¿ã‚¹ã‚¯ã®å…¨å®Ÿè¡Œãƒ­ã‚°ã‚’è¡¨ç¤º
```

#### å®Ÿè£…æ‰‹é †

1. orchestrate.tsã§ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’å‡ºåŠ›
2. `agent status` ã‚³ãƒãƒ³ãƒ‰ã‚’æ‹¡å¼µ
3. `agent logs` ã‚³ãƒãƒ³ãƒ‰ã‚’æ–°è¦ä½œæˆ
4. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆREADME.mdï¼‰ã‚’æ›´æ–°

#### æˆåŠŸåŸºæº–

- âœ… å®Ÿè¡Œå¾Œã«ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… `agent status` ã§å®Ÿè¡Œå±¥æ­´ãŒç¢ºèªã§ãã‚‹
- âœ… `agent logs` ã§ãƒ­ã‚°å†…å®¹ã‚’ç¢ºèªã§ãã‚‹

#### æ¨å®šå·¥æ•°
2-3æ™‚é–“

---

### Phase 4: Judgeåˆ¤å®šã®å¼·åŒ– ã€å„ªå…ˆåº¦: ä½ã€‘

**æ³¨**: CIçµ±åˆãŒå¿…è¦ãªãŸã‚ã€åˆ¥Epicã¨ã—ã¦æ‰±ã†

#### ç›®çš„
- ã‚¿ã‚¹ã‚¯ã®å®Ÿéš›ã®å®Œäº†çŠ¶æ…‹ã‚’ç¢ºèª
- CI/ãƒ†ã‚¹ãƒˆçµæœã«åŸºã¥ã„ãŸåˆ¤å®š
- å“è³ªä¿è¨¼ã®å‘ä¸Š

#### å¤‰æ›´å†…å®¹ï¼ˆæ¦‚è¦ã®ã¿ï¼‰

1. CIå®Ÿè¡Œçµæœã®å–å¾—
2. ãƒ†ã‚¹ãƒˆçµæœã®ç¢ºèª
3. ãƒ“ãƒ«ãƒ‰æˆåŠŸ/å¤±æ•—ã®åˆ¤å®š
4. å—ã‘å…¥ã‚ŒåŸºæº–ã®æ¤œè¨¼

#### æ¨å®šå·¥æ•°
6-8æ™‚é–“ï¼ˆCIçµ±åˆå«ã‚€ï¼‰

---

## å®Ÿè£…é †åº

### å®Ÿéš›ã®å®Ÿè£…é †åº

1. **Phase 1**: Workerå®Ÿè¡Œãƒ­ã‚°ã®ä¿å­˜ï¼ˆ2-3æ™‚é–“ï¼‰ âœ… å®Œäº†
   - ã™ãã«UXæ”¹å–„åŠ¹æœãŒå¾—ã‚‰ã‚Œã‚‹
   - æ—¢å­˜æ©Ÿèƒ½ã‚’æ´»ç”¨ã™ã‚‹ã ã‘ã§å®Ÿè£…å¯èƒ½
   - å¾Œç¶šãƒ•ã‚§ãƒ¼ã‚ºã®ãƒ‡ãƒãƒƒã‚°ã«ã‚‚å½¹ç«‹ã¤

2. **Phase 3**: CLIå‡ºåŠ›ã®æ”¹å–„ï¼ˆ2-3æ™‚é–“ï¼‰ âœ… å®Œäº†
   - Phase 1ã§ä¿å­˜ã—ãŸãƒ­ã‚°ã‚’æ´»ç”¨
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

3. **Phase 2**: Plannerã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆçµ±åˆï¼ˆ4-6æ™‚é–“ï¼‰ âœ… å®Œäº†ï¼ˆãŸã ã—ãƒã‚°ç™ºè¦‹ï¼‰
   - Phase 1ã®ãƒ­ã‚°æ©Ÿèƒ½ã§ãƒ‡ãƒãƒƒã‚°ã—ã‚„ã™ããªã‚‹
   - ã‚·ã‚¹ãƒ†ãƒ ã®æœ¬æ¥ã®ä¾¡å€¤ã‚’ç™ºæ®

4. **Phase 2.4**: runClaudeAgentãƒã‚°ä¿®æ­£ï¼ˆ30åˆ†ï¼‰ ğŸš§ å®Ÿè£…ä¸­
   - Phase 2å®Ÿè£…æ™‚ã®è¦‹è½ã¨ã—
   - 1è¡Œã®ä¿®æ­£ã§è§£æ±ºå¯èƒ½
   - **æœ€å„ªå…ˆã§ä¿®æ­£ãŒå¿…è¦**

5. **Phase 4**: Judgeåˆ¤å®šã®å¼·åŒ–ï¼ˆåˆ¥Epicï¼‰ ğŸ”œ æœªå®Ÿè£…
   - CIçµ±åˆãŒå¿…è¦
   - ã‚ˆã‚Šå¤§ããªè¨­è¨ˆæ±ºå®šãŒå¿…è¦

### æ¨å¥¨é †åºï¼ˆå°†æ¥ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‘ã‘ï¼‰

1. **Phase 1**: Workerå®Ÿè¡Œãƒ­ã‚°ã®ä¿å­˜ï¼ˆ2-3æ™‚é–“ï¼‰
2. **Phase 3**: CLIå‡ºåŠ›ã®æ”¹å–„ï¼ˆ2-3æ™‚é–“ï¼‰
3. **Phase 2**: Plannerã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆçµ±åˆï¼ˆ4-6æ™‚é–“ï¼‰
   - **é‡è¦**: SDKã®æˆ»ã‚Šå€¤æ§‹é€ ã‚’äº‹å‰ã«ç¢ºèªã™ã‚‹ã“ã¨
   - Phase 2.4ã®ã‚ˆã†ãªãƒã‚°ã‚’é˜²ããŸã‚ã€å˜ä½“ãƒ†ã‚¹ãƒˆã‚’ååˆ†ã«è¡Œã†
4. **Phase 4**: Judgeåˆ¤å®šã®å¼·åŒ–ï¼ˆåˆ¥Epicï¼‰

### æœ€å°é™ã®æ”¹å–„ï¼ˆã‚¯ã‚¤ãƒƒã‚¯ã‚¦ã‚£ãƒ³ï¼‰

ã‚‚ã—æ™‚é–“ãŒé™ã‚‰ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€**Phase 1ã®ã¿**ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

**Phase 1ã®ä¾¡å€¤**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé€”ä¸­çµŒéã‚’ç¢ºèªã§ãã‚‹
- ãƒ‡ãƒãƒƒã‚°ãŒå¯èƒ½ã«ãªã‚‹
- å®Ÿè£…ã‚³ã‚¹ãƒˆãŒä½ã„ï¼ˆ2-3æ™‚é–“ï¼‰
- æ—¢å­˜ã®RunnerEffectsã‚’æ´»ç”¨ã™ã‚‹ã ã‘

---

## ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### Phase 1ã®ãƒ†ã‚¹ãƒˆ

#### ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
```typescript
// tests/unit/core/orchestrator/worker-operations.test.ts
describe('executeTask with logging', () => {
  it('should save execution logs', async () => {
    // ...
  });

  it('should save metadata', async () => {
    // ...
  });

  it('should log errors', async () => {
    // ...
  });
});
```

#### E2Eãƒ†ã‚¹ãƒˆ
```bash
# tests/e2e/run-with-logs.test.ts
# agent runã‚’å®Ÿè¡Œã—ã¦ã€ãƒ­ã‚°ãŒä¿å­˜ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
```

### Phase 2ã®ãƒ†ã‚¹ãƒˆ

#### ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
```typescript
// tests/unit/core/orchestrator/planner-operations.test.ts
describe('parseAgentOutput', () => {
  it('should parse valid JSON array', () => {
    // ...
  });

  it('should extract JSON from markdown code blocks', () => {
    // ...
  });

  it('should handle invalid output gracefully', () => {
    // ...
  });
});
```

---

## ãƒªã‚¹ã‚¯ã¨å¯¾ç­–

### Phase 1ã®ãƒªã‚¹ã‚¯

**ãƒªã‚¹ã‚¯**: ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãããªã‚Šã™ãã‚‹

**å¯¾ç­–**:
- ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã®è¿½åŠ ï¼ˆå°†æ¥ï¼‰
- å¤ã„ãƒ­ã‚°ã®è‡ªå‹•å‰Šé™¤ï¼ˆå°†æ¥ï¼‰
- ç¾æ™‚ç‚¹ã§ã¯æ‰‹å‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã§å¯¾å‡¦

### Phase 2ã®ãƒªã‚¹ã‚¯

**ãƒªã‚¹ã‚¯**: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒä¸æ­£ãªJSONã‚’è¿”ã™

**å¯¾ç­–**:
- ãƒ‘ãƒ¼ã‚µãƒ¼ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å¼·åŒ– âœ… å®Ÿè£…æ¸ˆã¿
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ `createDummyTaskBreakdown` ã‚’ä¿æŒ âœ… å®Ÿè£…æ¸ˆã¿
- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ”¹å–„ï¼ˆJSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®å³å¯†åŒ–ï¼‰

**ãƒªã‚¹ã‚¯**: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œã‚³ã‚¹ãƒˆãŒå¢—åŠ 

**å¯¾ç­–**:
- ã‚¿ã‚¹ã‚¯æ•°ã®ä¸Šé™ã‚’è¨­å®šï¼ˆæœ€å¤§5ã‚¿ã‚¹ã‚¯ï¼‰
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿæ§‹ã®æ¤œè¨ï¼ˆå°†æ¥ï¼‰

**ğŸ”´ å®Ÿéš›ã«ç™ºç”Ÿã—ãŸãƒªã‚¹ã‚¯**: SDKã®æˆ»ã‚Šå€¤æ§‹é€ ã®èª¤è§£

**ç™ºç”Ÿå†…å®¹**:
- `unstable_v2_prompt`ã®æˆ»ã‚Šå€¤ã‚’æ­£ã—ãç†è§£ã—ã¦ã„ãªã‹ã£ãŸ
- `JSON.stringify(sdkResult)`ã‚’ä½¿ç”¨ã—ã¦ã—ã¾ã£ãŸ
- å®Ÿéš›ã«ã¯`sdkResult.result`ã‚’ä½¿ç”¨ã™ã¹ãã ã£ãŸ

**æ•™è¨“**:
- å¤–éƒ¨SDKã®æˆ»ã‚Šå€¤æ§‹é€ ã¯ã€å¿…ãšå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªã™ã‚‹
- å®Ÿè£…å‰ã«å°ã•ãªãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã§å‹•ä½œç¢ºèªã‚’è¡Œã†
- å˜ä½“ãƒ†ã‚¹ãƒˆã§SDKã®ãƒ¢ãƒƒã‚¯ã‚’é©åˆ‡ã«è¨­å®šã™ã‚‹

### Phase 2.4ã®ãƒªã‚¹ã‚¯

**ãƒªã‚¹ã‚¯**: ä¿®æ­£ãŒä»–ã®éƒ¨åˆ†ã«å½±éŸ¿ã™ã‚‹

**å¯¾ç­–**:
- ä¿®æ­£ã¯1è¡Œã®ã¿ã§ã‚ã‚Šã€å½±éŸ¿ç¯„å›²ãŒé™å®šçš„
- æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã§å›å¸°ã‚’ç¢ºèª

**âš ï¸ æ³¨æ„**: Codexã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚‚æœªæ¤œè¨¼
- `runCodexAgent`ã¯`turn.finalResponse`ã‚’ç›´æ¥ä½¿ç”¨ã—ã¦ã„ã‚‹ãŒã€å®Ÿéš›ã«ã¯å®Ÿè¡Œã•ã‚Œã¦ã„ãªã„
- Codex SDKã®å®Ÿéš›ã®æˆ»ã‚Šå€¤æ§‹é€ ãŒæƒ³å®šé€šã‚Šã‹ã¯æœªç¢ºèª
- Codexã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€åŒæ§˜ã®ãƒã‚°ãŒãªã„ã‹äº‹å‰ç¢ºèªãŒå¿…è¦

---

## å®Œäº†åŸºæº–

### Phase 1å®Œäº†åŸºæº–

- âœ… `agent run` å®Ÿè¡Œæ™‚ã« `runs/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ­ã‚°ãŒä¿å­˜ã•ã‚Œã‚‹
- âœ… ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¿ã‚¹ã‚¯é–‹å§‹ãƒ»å®Œäº†ãƒ»ã‚¨ãƒ©ãƒ¼ãŒè¨˜éŒ²ã•ã‚Œã‚‹
- âœ… ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã«å®Ÿè¡Œæƒ…å ±ãŒè¨˜éŒ²ã•ã‚Œã‚‹
- âœ… æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦ãƒ‘ã‚¹ã™ã‚‹
- âœ… E2Eãƒ†ã‚¹ãƒˆã§ãƒ­ã‚°ä¿å­˜ãŒæ¤œè¨¼ã•ã‚Œã‚‹

### Phase 2å®Œäº†åŸºæº–

- âœ… ãƒ€ãƒŸãƒ¼å®Ÿè£…ãŒå®Ÿéš›ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‘¼ã³å‡ºã—ã«ç½®ãæ›ãˆã‚‰ã‚Œã‚‹
- âš ï¸ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒè¤‡æ•°ã®ã‚¿ã‚¹ã‚¯ã‚’ç”Ÿæˆã™ã‚‹ï¼ˆãƒã‚°ã®ãŸã‚å‹•ä½œã›ãšï¼‰
- âœ… ãƒ‘ãƒ¼ã‚µãƒ¼ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦ãƒ‘ã‚¹ã™ã‚‹
- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒé©åˆ‡ã«æ©Ÿèƒ½ã™ã‚‹

### Phase 2.4å®Œäº†åŸºæº–

- â˜ `runClaudeAgent`ãŒ`sdkResult.result`ã‚’è¿”ã™ã‚ˆã†ã«ä¿®æ­£ã•ã‚Œã‚‹
- â˜ `parseAgentOutput`ãŒã‚¨ãƒ©ãƒ¼ãªããƒ‘ãƒ¼ã‚¹ã§ãã‚‹
- â˜ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒç”Ÿæˆã—ãŸè¤‡æ•°ã®ã‚¿ã‚¹ã‚¯ãŒæ­£ã—ãTaskStoreã«ä¿å­˜ã•ã‚Œã‚‹
- â˜ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ãƒ€ãƒŸãƒ¼ã‚¿ã‚¹ã‚¯ãŒä½¿ç”¨ã•ã‚Œãªã„
- â˜ æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦ãƒ‘ã‚¹ã™ã‚‹

### Phase 3å®Œäº†åŸºæº–

- âœ… ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€ãŒCLIã«è¡¨ç¤ºã•ã‚Œã‚‹
- âœ… `agent status` ã§ãƒ­ã‚°ç¢ºèªå¯èƒ½
- âœ… ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›´æ–°ã•ã‚Œã‚‹

---

## æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### å®Œäº†æ¸ˆã¿
1. âœ… ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼
2. âœ… Phase 1ã®å®Ÿè£…é–‹å§‹ã‚’æ±ºå®š
3. âœ… å®Ÿè£…ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆï¼ˆä¾‹: `feature/worker-logging`ï¼‰
4. âœ… Phase 1ã®å®Ÿè£…ã¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
5. âœ… Phase 1å®Œäº†å¾Œã€Phase 2ã®è©³ç´°è¨­è¨ˆã‚’é–‹å§‹
6. âœ… Phase 2, Phase 3ã®å®Ÿè£…å®Œäº†

### ğŸ”´ ç·Šæ€¥ã‚¿ã‚¹ã‚¯ï¼ˆPhase 2.4ï¼‰
1. **å³åº§å®Ÿè¡Œ**: `runClaudeAgent`ã®ãƒã‚°ä¿®æ­£
   - `src/core/runner/runner-effects-impl.ts:121`ã‚’ä¿®æ­£
   - `JSON.stringify(sdkResult)` â†’ `sdkResult.result`
2. ãƒ“ãƒ«ãƒ‰ã¨ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
3. å®Ÿéš›ã®å‹•ä½œç¢ºèªï¼ˆ`agent run`ã§è¤‡æ•°ã‚¿ã‚¹ã‚¯ç”Ÿæˆã‚’ç¢ºèªï¼‰
4. ãƒã‚°ä¿®æ­£ã‚’ã‚³ãƒŸãƒƒãƒˆ

### ä»Šå¾Œã®è¨ˆç”»
1. Phase 2.4å®Œäº†å¾Œã€ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®å‹•ä½œç¢ºèª
2. Phase 4ï¼ˆJudgeåˆ¤å®šã®å¼·åŒ–ï¼‰ã‚’åˆ¥Epicã¨ã—ã¦è¨ˆç”»
3. æœ¬ç•ªé‹ç”¨ã«å‘ã‘ãŸæº–å‚™

---

---

## Phase 5ä»¥é™: æ–°è¦è¦³ç‚¹ã®è¿½åŠ æ”¹å–„ ã€å„ªå…ˆåº¦: æ¤œè¨ä¸­ã€‘

### èƒŒæ™¯

Phase 1-3ã®å®Ÿè£…å¾Œã€å®Ÿéš›ã®é‹ç”¨ã‚’é€šã˜ã¦æ–°ãŸãªå•é¡Œç‚¹ã¨æ”¹å–„ã®å¿…è¦æ€§ãŒæ˜ã‚‰ã‹ã«ãªã£ãŸã€‚
ä»¥ä¸‹ã®è¦³ç‚¹ã‚’è¿½åŠ ã§æ¤œè¨ãƒ»å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

### 5.1 ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã®å“è³ªå‘ä¸Š ã€å„ªå…ˆåº¦: é«˜ã€‘ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âœ… å®Œäº†ã€‘

**å®Œäº†æ—¥**: 2026-01-19

#### å•é¡Œç‚¹
- ã‚¿ã‚¹ã‚¯ã®å†…å®¹ãŒä¸æ˜ç¢ºï¼ˆä¾‹: æ–‡æ›¸ä½œæˆæŒ‡ç¤ºã«å¯¾ã—ã¦å®Ÿè£…ã‚¿ã‚¹ã‚¯ãŒæ··å…¥ï¼‰
- ã‚¿ã‚¹ã‚¯ã®ç²’åº¦ãŒãƒãƒ©ãƒãƒ©ï¼ˆä¸€éƒ¨ã¯å¤§ãã™ãã€ä¸€éƒ¨ã¯å°ã•ã™ãï¼‰
- å…ƒã®æŒ‡ç¤ºã®æ„å›³ãŒæ­£ã—ãåæ˜ ã•ã‚Œãªã„
- è¦ªã‚¿ã‚¹ã‚¯ã‹ã‚‰å­ã‚¿ã‚¹ã‚¯ã¸ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä¼é”ãŒä¸ååˆ†
- acceptanceã¨contextãŒä¸å®Œå…¨ã§ã€ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã«å¿…è¦ãªæƒ…å ±ãŒä¸è¶³

#### æ”¹å–„å†…å®¹ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰

**5.1.1 TaskBreakdownå‹ã®Zodã‚¹ã‚­ãƒ¼ãƒå®šç¾©ï¼ˆå¿…é ˆåŒ–ï¼‰**

ã‚¹ã‚­ãƒ¼ãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³2ã¨ã—ã¦å®šç¾©:
- `type`: ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—ï¼ˆimplementation/documentation/investigation/integrationï¼‰
- `estimatedDuration`: è¦‹ç©æ™‚é–“ï¼ˆ0.5-8æ™‚é–“ã€1-4æ™‚é–“æ¨å¥¨ï¼‰
- `context`: ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã«å¿…è¦ãªå®Œå…¨ãªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±

```typescript
export const TaskBreakdownSchema = z.object({
  description: z.string().min(1),
  branch: z.string().min(1),
  scopePaths: z.array(z.string()).min(1),
  acceptance: z.string().min(1),
  type: z.enum(['implementation', 'documentation', 'investigation', 'integration']),
  estimatedDuration: z.number().min(0.5).max(8),
  context: z.string().min(1),
});
```

**5.1.2 Taskå‹ã®æ‹¡å¼µ**

æ°¸ç¶šåŒ–æ™‚ã«æ–°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¿æŒ:
- `taskType`: ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—
- `context`: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±

**5.1.3 ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å¤§å¹…æ”¹å–„**

`buildPlanningPrompt`ã‚’æ‹¡å¼µ:
- ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—ã®è©³ç´°èª¬æ˜
- ç²’åº¦ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ï¼ˆ1-4æ™‚é–“ç›®å®‰ã€æœ€å¤§8æ™‚é–“ï¼‰
- **COMPLETE acceptanceåŸºæº–**: WHATï¼ˆä½•ã‚’ï¼‰ã¨HOWï¼ˆæ¤œè¨¼æ–¹æ³•ï¼‰ã‚’æ˜ç¤ºã€ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ»ã‚¨ãƒ©ãƒ¼ã‚·ãƒŠãƒªã‚ªã‚’å«ã‚€
- **COMPLETE context**: å¤–éƒ¨å‚ç…§ãªã—ã§å®Œå…¨å®Ÿè¡Œå¯èƒ½ãªå…¨æƒ…å ±ï¼ˆæŠ€è¡“çš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã€ä¾å­˜é–¢ä¿‚ã€åˆ¶ç´„ã€æ—¢å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ãƒ†ã‚¹ãƒˆï¼‰
- å…·ä½“çš„ãªä¾‹ï¼ˆèªè¨¼å®Ÿè£…ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆï¼‰

**5.1.4 Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹å³æ ¼åŒ–**

`parseAgentOutput`ã‚’æ”¹å–„:
- Zodã‚¹ã‚­ãƒ¼ãƒã«ã‚ˆã‚‹å³æ ¼ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ`parseAgentOutputWithErrors`ï¼‰
- æ–°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ¬ è½æ™‚ã¯æ˜ç¢ºã«æ‹’å¦

**5.1.5 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„**

- ãƒ€ãƒŸãƒ¼ã‚¿ã‚¹ã‚¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å‰Šé™¤
- ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå¤±æ•—æ™‚ã¯æ˜ç¢ºã«ã‚¨ãƒ©ãƒ¼çµ‚äº†
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’ãƒ­ã‚°ã«è©³ç´°è¨˜éŒ²

#### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«
- `src/core/orchestrator/planner-operations.ts`: TaskBreakdownSchemaã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€ãƒ‘ãƒ¼ã‚µãƒ¼
- `src/types/task.ts`: Taskå‹æ‹¡å¼µã€createInitialTaskæ›´æ–°
- `tests/unit/core/orchestrator/planner-operations.test.ts`: ãƒ†ã‚¹ãƒˆæ‹¡å……
- `tests/unit/file-store.test.ts`: æ–°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¯¾å¿œ

#### æ¨å®šå·¥æ•°
4-6æ™‚é–“ï¼ˆå®Ÿç¸¾: ç´„5æ™‚é–“ï¼‰

#### å°†æ¥çš„ãªæ‹¡å¼µæ€§

ç¾åœ¨ã¯`context`ã¨`acceptance`ã«å…¨æƒ…å ±ã‚’å«ã‚ã‚‹ã“ã¨ã§ã‚¿ã‚¹ã‚¯ãŒè‡ªå·±å®Œçµçš„ã«å®Ÿè¡Œå¯èƒ½ã€‚

**Phase 5.4ï¼ˆç›´åˆ—ã‚¿ã‚¹ã‚¯ã‚µãƒãƒ¼ãƒˆï¼‰å®Ÿè£…å¾Œ**ã¯ã€ä»¥ä¸‹ã®ãƒ•ãƒ­ãƒ¼ã‚‚ã‚µãƒãƒ¼ãƒˆå¯èƒ½:
1. **ä»•æ§˜æ›¸ä½œæˆã‚¿ã‚¹ã‚¯**: è©³ç´°ãªè¦ä»¶/è¨­è¨ˆæ–‡æ›¸ã‚’ä½œæˆ
2. **å®Ÿè£…ã‚¿ã‚¹ã‚¯**: ãã®æ–‡æ›¸ã‚’`context`ã§å‚ç…§ã—ã¦å®Ÿè£…

ä¾‹:
```json
{
  "description": "Implement authentication based on spec",
  "type": "implementation",
  "context": "Refer to auth-spec.md created in previous task for detailed requirements. Implement JWT authentication with bcrypt password hashing as specified.",
  "dependencies": ["Create authentication specification document"]
}
```

---

### 5.2 ã‚¸ãƒ£ãƒƒã‚¸ã«ã‚ˆã‚‹ã‚¿ã‚¹ã‚¯å“è³ªè©•ä¾¡ ã€å„ªå…ˆåº¦: é«˜ã€‘ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âœ… å®Œäº†ã€‘

**å®Œäº†æ—¥**: 2026-01-19

#### å•é¡Œç‚¹
- ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ãŒç”Ÿæˆã—ãŸã‚¿ã‚¹ã‚¯ã®å“è³ªã‚’èª°ã‚‚è©•ä¾¡ã—ã¦ã„ãªã„
- ä¸æ˜ç¢ºãªã‚¿ã‚¹ã‚¯ãŒãã®ã¾ã¾å®Ÿè¡Œã•ã‚Œã¦ã—ã¾ã†

#### æ”¹å–„å†…å®¹ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰

**5.2.1 ã‚¿ã‚¹ã‚¯ç”Ÿæˆç›´å¾Œã®å“è³ªè©•ä¾¡**

æ–°ã—ã„é–¢æ•° `judgeTaskQuality` ã®è¿½åŠ :
```typescript
interface TaskQualityJudgement {
  isAcceptable: boolean;
  issues: string[];
  suggestions: string[];
}

const judgeTaskQuality = async (
  taskBreakdowns: TaskBreakdown[],
  originalInstruction: string
): Promise<TaskQualityJudgement> => {
  // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«å“è³ªè©•ä¾¡ã‚’ä¾é ¼
  const judgementPrompt = buildTaskQualityPrompt(taskBreakdowns, originalInstruction);
  const result = await runnerEffects.runClaudeAgent(
    judgementPrompt,
    appRepoPath,
    'claude-haiku-4-5-20250929', // è»½é‡ãƒ¢ãƒ‡ãƒ«ä½¿ç”¨
  );

  return parseQualityJudgement(result.val.finalResponse);
};
```

**5.2.2 å“è³ªä¸è¶³æ™‚ã®å†ç”Ÿæˆãƒ•ãƒ­ãƒ¼**

`planTasks`ã‚’æ‹¡å¼µ:
```typescript
const planTasks = async (userInstruction: string) => {
  let attempts = 0;
  const maxAttempts = 3;

  while (attempts < maxAttempts) {
    const taskBreakdowns = await generateTaskBreakdowns(userInstruction);
    const quality = await judgeTaskQuality(taskBreakdowns, userInstruction);

    if (quality.isAcceptable) {
      return saveAndReturnTasks(taskBreakdowns);
    }

    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å«ã‚ã¦å†ç”Ÿæˆ
    userInstruction = appendFeedback(userInstruction, quality.issues, quality.suggestions);
    attempts++;
  }

  // æœ€å¤§è©¦è¡Œå›æ•°ã‚’è¶…ãˆãŸå ´åˆã¯ã‚¨ãƒ©ãƒ¼
  throw new Error('Failed to generate acceptable tasks after 3 attempts');
};
```

**5.2.3 å®Ÿè£…çµ±åˆ**

`createPlannerOperations`å†…ã«`judgeTaskQuality`é–¢æ•°ã‚’è¿½åŠ ã—ã€`planTasks`ã§å“è³ªè©•ä¾¡ãƒ«ãƒ¼ãƒ—ã‚’å®Ÿè£…:
- æœ€å¤§3å›ã¾ã§ã®å†ç”Ÿæˆè©¦è¡Œ
- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è“„ç©ã—ã¦æ¬¡å›ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«åæ˜ 
- å“è³ªè©•ä¾¡ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå¤±æ•—æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¨±å®¹ï¼ˆå¯ç”¨æ€§å„ªå…ˆï¼‰

#### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«
- `src/core/orchestrator/planner-operations.ts`: å“è³ªè©•ä¾¡ãƒ­ã‚¸ãƒƒã‚¯ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€ãƒ‘ãƒ¼ã‚µãƒ¼
- `src/core/orchestrator/orchestrate.ts`: PlannerDepsã«judgeModelè¿½åŠ 
- `tests/unit/core/orchestrator/planner-operations.test.ts`: å“è³ªè©•ä¾¡ãƒ†ã‚¹ãƒˆè¿½åŠ ï¼ˆ8ãƒ†ã‚¹ãƒˆï¼‰

#### ãƒ†ã‚¹ãƒˆçµæœ
- ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ: 31/31 ãƒ‘ã‚¹ âœ…
- ãƒ“ãƒ«ãƒ‰: æˆåŠŸ âœ…

#### æ¨å®šå·¥æ•°
6-8æ™‚é–“ï¼ˆå®Ÿç¸¾: ç´„4æ™‚é–“ï¼‰

---

### 5.3 ä¸¦åˆ—å®Ÿè¡Œã‚µãƒãƒ¼ãƒˆ ã€å„ªå…ˆåº¦: é«˜ã€‘ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âœ… å®Œäº†ã€‘

**å®Œäº†æ—¥**: 2026-01-19

#### å•é¡Œç‚¹
- `maxWorkers`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹ãŒã€å®Ÿéš›ã«ã¯ç›´åˆ—å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ï¼ˆorchestrate.ts:122-193ã®forãƒ«ãƒ¼ãƒ—ï¼‰
- ã‚¿ã‚¹ã‚¯é–“ã®ä¾å­˜é–¢ä¿‚ãŒè€ƒæ…®ã•ã‚Œã¦ã„ãªã„

#### æ”¹å–„å†…å®¹ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰

**5.3.1 å‹å®šç¾©ã®æ‹¡å¼µ**

Taskå‹ã¨TaskBreakdownã«`dependencies`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ :
```typescript
// src/types/task.ts
export const TaskSchema = z.object({
  // ...
  dependencies: z.array(z.string().transform(taskId)).default([]),
});

// src/core/orchestrator/planner-operations.ts
export const TaskBreakdownSchema = z.object({
  id: z.string(),  // Planneræ®µéšã§IDå‰²ã‚Šå½“ã¦
  // ...
  dependencies: z.array(z.string()).default([]),
});
```

**5.3.2 ä¾å­˜é–¢ä¿‚ã‚°ãƒ©ãƒ•ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å®Ÿè£…**

æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ« `src/core/orchestrator/dependency-graph.ts`:
- `buildDependencyGraph`: ã‚¿ã‚¹ã‚¯é–“ã®ä¾å­˜é–¢ä¿‚ã‚°ãƒ©ãƒ•ã‚’æ§‹ç¯‰
- `detectCycles`: Tarjan's SCCã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§å¾ªç’°ä¾å­˜ã‚’æ¤œå‡º
- `computeExecutionLevels`: Kahn's Algorithmã§ãƒˆãƒãƒ­ã‚¸ã‚«ãƒ«ã‚½ãƒ¼ãƒˆã€å®Ÿè¡Œãƒ¬ãƒ™ãƒ«ã‚’è¨ˆç®—

**5.3.3 ä¸¦åˆ—å®Ÿè¡Œå™¨ã®å®Ÿè£…**

æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ« `src/core/orchestrator/parallel-executor.ts`:
- `executeLevelParallel`: åŒãƒ¬ãƒ™ãƒ«ã®ã‚¿ã‚¹ã‚¯ã‚’`Promise.allSettled`ã§ä¸¦åˆ—å®Ÿè¡Œ
- `computeBlockedTasks`: å¤±æ•—ã‚¿ã‚¹ã‚¯ã®ä¾å­˜å…ˆã‚’è‡ªå‹•çš„ã«ãƒ–ãƒ­ãƒƒã‚¯

**5.3.4 Orchestratorçµ±åˆ**

`src/core/orchestrator/orchestrate.ts`ã®`executeInstruction`ã‚’æ›¸ãæ›ãˆ:
```typescript
// 1. ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ã‚’å–å¾—ã—ã¦ä¾å­˜é–¢ä¿‚ã‚°ãƒ©ãƒ•ã‚’æ§‹ç¯‰
const tasks: Task[] = [];
for (const rawTaskId of taskIds) {
  const taskResult = await deps.taskStore.readTask(taskId(rawTaskId));
  tasks.push(taskResult.val);
}
const graph = buildDependencyGraph(tasks);

// 2. å¾ªç’°ä¾å­˜ã‚’ãƒã‚§ãƒƒã‚¯
if (graph.cyclicDependencies && graph.cyclicDependencies.length > 0) {
  // å¾ªç’°ä¾å­˜ã‚¿ã‚¹ã‚¯ã‚’BLOCKEDã«ã™ã‚‹
}

// 3. å®Ÿè¡Œãƒ¬ãƒ™ãƒ«ã‚’è¨ˆç®—
const { levels, unschedulable } = computeExecutionLevels(graph);

// 4. ãƒ¬ãƒ™ãƒ«ã”ã¨ã«ä¸¦åˆ—å®Ÿè¡Œ
for (let levelIndex = 0; levelIndex < levels.length; levelIndex++) {
  const level = levels[levelIndex];
  const levelResult = await executeLevelParallel(
    level,
    schedulerOps,
    workerOps,
    judgeOps,
    schedulerState,
    blockedTaskIds,
  );

  // å¤±æ•—ã‚¿ã‚¹ã‚¯ã®ä¾å­˜å…ˆã‚’ãƒ–ãƒ­ãƒƒã‚¯
  const newBlocked = computeBlockedTasks(levelResult.failed, graph);
}
```

**5.3.5 ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ‹¡å¼µ**

`buildPlanningPrompt`ã«IDã¨ä¾å­˜é–¢ä¿‚ã®èª¬æ˜ã‚’è¿½åŠ :
```
IMPORTANT: You must assign a unique ID to each task. Use the format "task-1", "task-2", etc.
When one task depends on another, reference it by ID in the dependencies array.

For each task, provide:
1. id: Unique task identifier (e.g., "task-1", "task-2")
...
9. dependencies: Array of task IDs this task depends on (REQUIRED)
   - Empty array [] if the task has no dependencies
   - List task IDs that must be completed BEFORE this task can start
```

#### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«
- `src/types/task.ts`: Taskå‹ã«`dependencies`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
- `src/core/orchestrator/planner-operations.ts`: TaskBreakdownã«`id`ã¨`dependencies`è¿½åŠ 
- `src/core/orchestrator/dependency-graph.ts`: ä¾å­˜é–¢ä¿‚ã‚°ãƒ©ãƒ•æ§‹ç¯‰ãƒ»å¾ªç’°ä¾å­˜æ¤œå‡ºãƒ»ãƒ¬ãƒ™ãƒ«è¨ˆç®—ï¼ˆæ–°è¦ï¼‰
- `src/core/orchestrator/parallel-executor.ts`: ä¸¦åˆ—å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ–°è¦ï¼‰
- `src/core/orchestrator/orchestrate.ts`: ä¸¦åˆ—å®Ÿè¡Œçµ±åˆ
- `tests/unit/core/orchestrator/dependency-graph.test.ts`: ä¾å­˜é–¢ä¿‚ã‚°ãƒ©ãƒ•ãƒ†ã‚¹ãƒˆï¼ˆæ–°è¦ã€11ãƒ†ã‚¹ãƒˆï¼‰
- `tests/unit/core/orchestrator/planner-operations.test.ts`: æ—¢å­˜ãƒ†ã‚¹ãƒˆæ›´æ–°

#### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥
- å¾ªç’°ä¾å­˜æ¤œå‡ºæ™‚: è©²å½“ã‚¿ã‚¹ã‚¯ã‚’BLOCKEDã€ä»–ã¯ç¶šè¡Œ
- ä¾å­˜ã‚¿ã‚¹ã‚¯å¤±æ•—æ™‚: å¾Œç¶šã‚¿ã‚¹ã‚¯ã‚’BLOCKEDã€åŒãƒ¬ãƒ™ãƒ«ä»–ã‚¿ã‚¹ã‚¯ã¯ç¶šè¡Œ
- ä¸¦åˆ—å®Ÿè¡Œä¸­ã®1ã‚¿ã‚¹ã‚¯å¤±æ•—: åŒãƒ¬ãƒ™ãƒ«ä»–ã‚¿ã‚¹ã‚¯ã¯ç¶šè¡Œ

#### ãƒ†ã‚¹ãƒˆçµæœ
- ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ: 41/41 ãƒ‘ã‚¹ âœ…
- ãƒ“ãƒ«ãƒ‰: æˆåŠŸ âœ…

#### å®Ÿè¡Œãƒ•ãƒ­ãƒ¼
```
Level 0: [A, B]     â† ä¾å­˜ãªã—ã€ä¸¦åˆ—å®Ÿè¡Œ
Level 1: [C]        â† A,Bã«ä¾å­˜
Level 2: [D, E, F]  â† Cã«ä¾å­˜ã€ä¸¦åˆ—å®Ÿè¡Œ
```

#### æ¨å®šå·¥æ•°
8-12æ™‚é–“ï¼ˆå®Ÿç¸¾: ç´„10æ™‚é–“ï¼‰

---

### 5.4 ç›´åˆ—ã‚¿ã‚¹ã‚¯ã®å¤‰æ›´çµ±åˆ ã€å„ªå…ˆåº¦: ä¸­ã€‘ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âœ… å®Œäº†ã€‘

**å®Œäº†æ—¥**: 2026-01-19

#### å•é¡Œç‚¹
- ç›´åˆ—ã‚¿ã‚¹ã‚¯ã®å ´åˆã€å‰ã®ã‚¿ã‚¹ã‚¯ã®å¤‰æ›´çµæœã‚’æ¬¡ã®ã‚¿ã‚¹ã‚¯ãŒå—ã‘å–ã‚Œãªã„
- å„worktreeã«çµæœãŒæ•£ã‚‰ã°ã£ãŸã¾ã¾

#### æ”¹å–„å†…å®¹ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰

**5.4.1 ç›´åˆ—ã‚¿ã‚¹ã‚¯ã®æ¤œå‡º**

ä¾å­˜é–¢ä¿‚ã‚°ãƒ©ãƒ•ã‹ã‚‰ç›´åˆ—ãƒã‚§ãƒ¼ãƒ³ã‚’æ¤œå‡º:
```typescript
const detectSerialChains = (taskGraph: DependencyGraph): TaskId[][] => {
  // A -> B -> C ã®ã‚ˆã†ãªç›´ç·šçš„ãªä¾å­˜é–¢ä¿‚ã‚’æ¤œå‡º
  return findLinearDependencyChains(taskGraph);
};
```

**5.4.2 åŒä¸€worktreeã§ã®å®Ÿè¡Œ**

ç›´åˆ—ãƒã‚§ãƒ¼ãƒ³ã¯åŒã˜worktreeã‚’å†åˆ©ç”¨:
```typescript
const executeSerialChain = async (chain: TaskId[]) => {
  let worktreePath = null;

  for (const taskId of chain) {
    if (!worktreePath) {
      // æœ€åˆã®ã‚¿ã‚¹ã‚¯: æ–°ã—ã„worktreeã‚’ä½œæˆ
      worktreePath = await createWorktree(taskId);
    } else {
      // å¾Œç¶šã‚¿ã‚¹ã‚¯: æ—¢å­˜ã®worktreeã‚’å†åˆ©ç”¨
      // å‰ã®ã‚¿ã‚¹ã‚¯ã®å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
      await commitChanges(worktreePath, taskId);
    }

    await executeTaskInWorktree(taskId, worktreePath);
  }

  // ãƒã‚§ãƒ¼ãƒ³å®Œäº†å¾Œã«worktreeã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  await cleanupWorktree(worktreePath);
};
```

**5.4.3 ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®ä¼é”**

å‰ã®ã‚¿ã‚¹ã‚¯ã®å®Ÿè¡Œçµæœã‚’æ¬¡ã®ã‚¿ã‚¹ã‚¯ã«æ¸¡ã™:
```typescript
const executeTaskInWorktree = async (
  taskId: TaskId,
  worktreePath: WorktreePath,
  previousTaskFeedback?: string
) => {
  const prompt = previousTaskFeedback
    ? `Execute task: ${task.acceptance}\n\nPrevious task feedback:\n${previousTaskFeedback}`
    : `Execute task: ${task.acceptance}`;

  // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œ
  const result = await runAgent(prompt, worktreePath);

  return {
    success: result.success,
    feedback: extractFeedback(result.output),
  };
};
```

#### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«
- `src/core/orchestrator/dependency-graph.ts`: `detectSerialChains`é–¢æ•°ã‚’è¿½åŠ 
- `src/core/orchestrator/worker-operations.ts`: `executeTaskInExistingWorktree`é–¢æ•°ã‚’è¿½åŠ 
- `src/core/orchestrator/serial-executor.ts`: ç›´åˆ—ãƒã‚§ãƒ¼ãƒ³å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ–°è¦ï¼‰
- `src/core/orchestrator/orchestrate.ts`: ç›´åˆ—ãƒã‚§ãƒ¼ãƒ³å®Ÿè¡Œã‚’çµ±åˆ
- `tests/unit/core/orchestrator/dependency-graph.test.ts`: detectSerialChainsãƒ†ã‚¹ãƒˆè¿½åŠ ï¼ˆ6ãƒ†ã‚¹ãƒˆï¼‰

#### å®Ÿè£…ã®è©³ç´°

**ç›´åˆ—ãƒã‚§ãƒ¼ãƒ³æ¤œå‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **:
- å…¥æ¬¡æ•°ï¼ˆä¾å­˜å…ˆã®æ•°ï¼‰ã¨å‡ºæ¬¡æ•°ï¼ˆä¾å­˜å…ƒã®æ•°ï¼‰ã‚’è¨ˆç®—
- å„ã‚¿ã‚¹ã‚¯ãŒå³å¯†ã«1ã¤ã®ä¾å­˜å…ˆã¨1ã¤ã®ä¾å­˜å…ƒã‚’æŒã¤ãƒã‚§ãƒ¼ãƒ³ã‚’æ¤œå‡º
- ãƒã‚§ãƒ¼ãƒ³ã®é•·ã•ãŒ2ä»¥ä¸Šã®ã‚‚ã®ã®ã¿è¿”ã™ï¼ˆå˜ç‹¬ã‚¿ã‚¹ã‚¯ã¯ä¸¦åˆ—å®Ÿè¡Œã®æ–¹ãŒåŠ¹ç‡çš„ï¼‰

**å®Ÿè¡Œæˆ¦ç•¥**:
- ç›´åˆ—ãƒã‚§ãƒ¼ãƒ³ã¨ä¸¦åˆ—ã‚¿ã‚¹ã‚¯ã‚’åˆ†é›¢
- ç›´åˆ—ãƒã‚§ãƒ¼ãƒ³ã¯é †ç•ªã«å®Ÿè¡Œï¼ˆåŒä¸€worktreeã‚’å…±æœ‰ï¼‰
- ä¸¦åˆ—ã‚¿ã‚¹ã‚¯ã¯å¾“æ¥é€šã‚Šãƒ¬ãƒ™ãƒ«ãƒ™ãƒ¼ã‚¹ã§ä¸¦åˆ—å®Ÿè¡Œ
- å„ç›´åˆ—ãƒã‚§ãƒ¼ãƒ³å®Œäº†å¾Œã«worktreeã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

**ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ä¼é”**:
- å‰ã®ã‚¿ã‚¹ã‚¯ã®RunIDã‚’æ¬¡ã®ã‚¿ã‚¹ã‚¯ã«æ¸¡ã™
- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å‰ã®ã‚¿ã‚¹ã‚¯ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å«ã‚ã‚‹
- ãƒ­ã‚°ã«æ˜ç¤ºçš„ã«è¨˜éŒ²ï¼ˆ`Worktree: <path> (reused)`ï¼‰

#### ãƒ†ã‚¹ãƒˆçµæœ
- ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ: 47/47 ãƒ‘ã‚¹ âœ…
- æ–°è¦ãƒ†ã‚¹ãƒˆ: detectSerialChains 6ãƒ†ã‚¹ãƒˆè¿½åŠ 
- ãƒ“ãƒ«ãƒ‰: æˆåŠŸ âœ…

#### æ¨å®šå·¥æ•°
6-8æ™‚é–“ï¼ˆå®Ÿç¸¾: ç´„6æ™‚é–“ï¼‰

---

### 5.5 çµ±åˆå‡¦ç†ã¨ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±º ã€å„ªå…ˆåº¦: ä¸­ã€‘ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âœ… å®Œäº†ã€‘

**å®Œäº†æ—¥**: 2026-01-19

#### å•é¡Œç‚¹
- ä¸¦åˆ—å®Ÿè¡Œã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã®çµæœãŒãã‚Œãã‚Œã®worktreeã«æ•£ã‚‰ã°ã£ã¦ã„ã‚‹
- çµ±åˆæ™‚ã«ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§
- ä¸¦åˆ—å®Ÿè¡Œå¾Œã€å„ã‚¿ã‚¹ã‚¯ã®å¤‰æ›´ã¯å€‹åˆ¥ãƒ–ãƒ©ãƒ³ãƒã«pushã•ã‚Œã‚‹ãŒã€çµ±åˆã•ã‚Œãªã„

#### æ”¹å–„å†…å®¹ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰

**5.5.1 å‹å®šç¾©ã®è¿½åŠ **

æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ« `src/types/integration.ts`:
- `GitConflictInfo`: ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæƒ…å ±
- `ConflictContent`: ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã®è©³ç´°å†…å®¹
- `MergeResult`: ãƒãƒ¼ã‚¸çµæœï¼ˆæˆåŠŸ/ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆ/å¤±æ•—ï¼‰
- `IntegrationResult`: çµ±åˆçµæœï¼ˆçµ±åˆæ¸ˆã¿ã‚¿ã‚¹ã‚¯ã€ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã€è§£æ±ºã‚¿ã‚¹ã‚¯IDï¼‰
- `IntegrationFinalResult`: çµ±åˆãƒ–ãƒ©ãƒ³ãƒå–ã‚Šè¾¼ã¿æ–¹æ³•ï¼ˆdiscriminated union: 'pr' | 'command'ï¼‰
- `ConflictResolutionInfo`: ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºæƒ…å ±

`src/types/errors.ts`ã«`GitMergeConflictError`ã‚’è¿½åŠ ã€‚

**5.5.2 GitEffectsã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹æ‹¡å¼µ**

`src/adapters/vcs/git-effects.ts`ã«ãƒãƒ¼ã‚¸é–¢é€£ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ :
- `merge`: ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒãƒ¼ã‚¸ï¼ˆã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæ¤œå‡ºå«ã‚€ï¼‰
- `abortMerge`: é€²è¡Œä¸­ã®ãƒãƒ¼ã‚¸ã‚’ä¸­æ­¢
- `getConflictedFiles`: ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆå–å¾—
- `getConflictContent`: ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆå†…å®¹ã®è©³ç´°å–å¾—
- `markConflictResolved`: ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºæ¸ˆã¿ãƒãƒ¼ã‚¯

**5.5.3 simple-git-effectsã®å®Ÿè£…**

`src/adapters/vcs/simple-git-effects.ts`ã«ãƒãƒ¼ã‚¸æ“ä½œã‚’å®Ÿè£…:
- `merge`: simple-gitã®`merge()`ã‚’ä½¿ç”¨ã€`GitResponseError`ã§ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæ¤œå‡º
- `getConflictedFiles`: `status().conflicted`é…åˆ—ã‚’å–å¾—
- `getConflictContent`: `git show :1:/:2:/:3:`ã§base/ours/theirsã‚’å–å¾—
- ãã®ä»–ã®ãƒãƒ¼ã‚¸è£œåŠ©ãƒ¡ã‚½ãƒƒãƒ‰

**5.5.4 integration-operationsã®å®Ÿè£…**

æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ« `src/core/orchestrator/integration-operations.ts`:

ä¸»è¦é–¢æ•°:
- `integrateTasks`: è¤‡æ•°ã‚¿ã‚¹ã‚¯ãƒ–ãƒ©ãƒ³ãƒã‚’çµ±åˆãƒ–ãƒ©ãƒ³ãƒï¼ˆ`integration/merge-{timestamp}`ï¼‰ã«ãƒãƒ¼ã‚¸
- `createConflictResolutionTask`: ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆç™ºç”Ÿæ™‚ã«è§£æ±ºã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•ç”Ÿæˆ
- `buildConflictResolutionPrompt`: ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºç”¨ã®è©³ç´°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
- `collectConflictDetails`: ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè©³ç´°æƒ…å ±ã‚’åé›†
- `finalizeIntegration`: çµ±åˆãƒ–ãƒ©ãƒ³ãƒã®å–ã‚Šè¾¼ã¿æ–¹æ³•ã‚’æ±ºå®š

çµ±åˆãƒ•ãƒ­ãƒ¼:
1. çµ±åˆãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆï¼ˆ`integration/merge-{timestamp}`ï¼‰
2. å„ã‚¿ã‚¹ã‚¯ã®ãƒ–ãƒ©ãƒ³ãƒã‚’é †ç•ªã«ãƒãƒ¼ã‚¸
3. ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆç™ºç”Ÿæ™‚ã¯ã‚¢ãƒœãƒ¼ãƒˆã—ã¦è§£æ±ºã‚¿ã‚¹ã‚¯ã‚’ç”Ÿæˆ
4. çµ±åˆæˆåŠŸæ™‚ï¼šè¨­å®š/ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«åŸºã¥ã„ã¦å‡¦ç†
   - `pr`: GitHub CLIã§PRä½œæˆï¼ˆãƒªãƒ¢ãƒ¼ãƒˆå¿…é ˆã€ç¾æ™‚ç‚¹ã§ã¯æœªå®Ÿè£…ï¼‰
   - `command`: ãƒãƒ¼ã‚¸ã‚³ãƒãƒ³ãƒ‰ã‚’å‡ºåŠ›
   - `auto`ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰: ãƒªãƒ¢ãƒ¼ãƒˆãŒã‚ã‚Œã°PRã€ãªã‘ã‚Œã°ã‚³ãƒãƒ³ãƒ‰ï¼ˆç¾æ™‚ç‚¹ã§ã¯ã‚³ãƒãƒ³ãƒ‰ï¼‰

**5.5.5 è¨­å®šã®è¿½åŠ **

`src/types/config.ts`ã«çµ±åˆè¨­å®šã‚’è¿½åŠ :
```typescript
integration: {
  method: 'pr' | 'command' | 'auto'  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 'auto'
}
```

**5.5.6 orchestrate.tsã¸ã®çµ±åˆ**

`src/core/orchestrator/orchestrate.ts`ã®`executeInstruction`ã«çµ±åˆãƒ•ã‚§ãƒ¼ã‚ºã‚’è¿½åŠ :
- å®Œäº†ã‚¿ã‚¹ã‚¯ãŒè¤‡æ•°ã‚ã‚‹å ´åˆã®ã¿çµ±åˆã‚’å®Ÿè¡Œ
- çµ±åˆçµæœã«åŸºã¥ã„ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é©åˆ‡ãªæƒ…å ±ã‚’è¡¨ç¤º
- ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆç™ºç”Ÿæ™‚ã¯è§£æ±ºã‚¿ã‚¹ã‚¯IDã‚’è¡¨ç¤º

#### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«
- `src/types/integration.ts`: çµ±åˆé–¢é€£ã®å‹å®šç¾©ï¼ˆæ–°è¦ï¼‰
- `src/types/errors.ts`: GitMergeConflictErrorè¿½åŠ 
- `src/types/config.ts`: çµ±åˆè¨­å®šè¿½åŠ 
- `src/adapters/vcs/git-effects.ts`: ãƒãƒ¼ã‚¸é–¢é€£ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
- `src/adapters/vcs/simple-git-effects.ts`: ãƒãƒ¼ã‚¸æ“ä½œã®å®Ÿè£…
- `src/core/orchestrator/integration-operations.ts`: çµ±åˆå‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ–°è¦ï¼‰
- `src/core/orchestrator/orchestrate.ts`: çµ±åˆãƒ•ã‚§ãƒ¼ã‚ºè¿½åŠ 
- `tests/unit/core/orchestrator/integration-operations.test.ts`: çµ±åˆå‡¦ç†ãƒ†ã‚¹ãƒˆï¼ˆæ–°è¦ã€12ãƒ†ã‚¹ãƒˆï¼‰
- `tests/unit/adapters/vcs/simple-git-effects-merge.test.ts`: ãƒãƒ¼ã‚¸æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼ˆæ–°è¦ï¼‰

#### ãƒ†ã‚¹ãƒˆçµæœ
- ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ: 59/59 ãƒ‘ã‚¹ âœ…
- ãƒ“ãƒ«ãƒ‰: æˆåŠŸ âœ…
- Lint: æˆåŠŸ âœ…

#### æ¨å®šå·¥æ•°
11-12æ™‚é–“ï¼ˆå®Ÿç¸¾: ç´„11æ™‚é–“ï¼‰

#### å‚™è€ƒ
- PRä½œæˆæ©Ÿèƒ½ï¼ˆGitHub CLIçµ±åˆï¼‰ã¯å°†æ¥ã®å®Ÿè£…äºˆå®š
- ç¾æ™‚ç‚¹ã§ã¯çµ±åˆãƒ–ãƒ©ãƒ³ãƒã®ãƒãƒ¼ã‚¸ã‚³ãƒãƒ³ãƒ‰ã‚’å‡ºåŠ›ã™ã‚‹å½¢ã§é‹ç”¨

---

### 5.6 ã‚¸ãƒ£ãƒƒã‚¸åˆ¤å®šã®é«˜åº¦åŒ– ã€å„ªå…ˆåº¦: ä¸­ã€‘

#### å•é¡Œç‚¹
- ç¾åœ¨ã®åˆ¤å®šãŒå˜ç´”ã™ãã‚‹ï¼ˆRUNNING = æˆåŠŸï¼‰
- ã‚¿ã‚¹ã‚¯å†…å®¹ã«å¯¾ã™ã‚‹ååˆ†æ€§ã‚’è©•ä¾¡ã—ã¦ã„ãªã„

#### æ”¹å–„å†…å®¹

**5.6.1 ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ™ãƒ¼ã‚¹ã®åˆ¤å®š**

`judgeTask`ã‚’ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‘¼ã³å‡ºã—ã«ç½®ãæ›ãˆ:
```typescript
const judgeTask = async (tid: TaskId): Promise<Result<JudgementResult, TaskStoreError>> => {
  const taskResult = await deps.taskStore.readTask(tid);
  if (!taskResult.ok) return createErr(taskResult.err);

  const task = taskResult.val;

  // å®Ÿè¡Œãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿
  const runLog = await loadTaskRunLog(tid);

  // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«åˆ¤å®šã‚’ä¾é ¼
  const judgementPrompt = buildJudgementPrompt(task, runLog);
  const result = await runnerEffects.runClaudeAgent(
    judgementPrompt,
    appRepoPath,
    'claude-haiku-4-5-20250929', // è»½é‡ãƒ¢ãƒ‡ãƒ«ä½¿ç”¨
  );

  return parseJudgementResult(result.val.finalResponse);
};
```

**5.6.2 åˆ¤å®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**

```typescript
const buildJudgementPrompt = (task: Task, runLog: string): string => {
  return `You are a task completion judge.

TASK ACCEPTANCE CRITERIA:
${task.acceptance}

EXECUTION LOG:
${runLog}

Your task:
1. Determine if the acceptance criteria were met
2. Check if the implementation is complete and functional
3. Identify any missing requirements or issues

Output (JSON):
{
  "success": true/false,
  "reason": "Detailed explanation",
  "missingRequirements": ["req1", "req2"],
  "shouldContinue": true/false
}`;
};
```

#### æ¨å®šå·¥æ•°
4-6æ™‚é–“

---

### 5.7 å…¨ä½“å®Œäº†åˆ¤å®š ã€å„ªå…ˆåº¦: ä¸­ã€‘

#### å•é¡Œç‚¹
- å…¨ã‚¿ã‚¹ã‚¯å®Œäº†å¾Œã«ã€æœ¬å½“ã«å…ƒã®æŒ‡ç¤ºãŒé”æˆã•ã‚ŒãŸã‹ã‚’ç¢ºèªã—ã¦ã„ãªã„

#### æ”¹å–„å†…å®¹

**5.7.1 æœ€çµ‚åˆ¤å®šãƒ•ã‚§ãƒ¼ã‚ºã®è¿½åŠ **

`executeInstruction`ã®æœ€å¾Œã«æœ€çµ‚åˆ¤å®šã‚’è¿½åŠ :
```typescript
const executeInstruction = async (userInstruction: string) => {
  // ... æ—¢å­˜ã®ã‚¿ã‚¹ã‚¯å®Ÿè¡Œ ...

  // å…¨ã‚¿ã‚¹ã‚¯å®Œäº†å¾Œã®æœ€çµ‚åˆ¤å®š
  const finalJudgement = await judgeFinalCompletion(
    userInstruction,
    completedTaskIds,
    failedTaskIds
  );

  if (!finalJudgement.isComplete) {
    console.log('âš ï¸  Original instruction not fully satisfied. Generating additional tasks...');

    // è¿½åŠ ã‚¿ã‚¹ã‚¯ã‚’ç”Ÿæˆ
    const additionalTasks = await planAdditionalTasks(
      userInstruction,
      finalJudgement.missingAspects
    );

    // è¿½åŠ ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œ
    return executeAdditionalTasks(additionalTasks);
  }

  return createOk({ success: true, ... });
};
```

**5.7.2 æœ€çµ‚åˆ¤å®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**

```typescript
const buildFinalJudgementPrompt = (
  instruction: string,
  completedTasks: Task[],
  failedTasks: Task[]
): string => {
  return `You are judging if the original user instruction was fully completed.

ORIGINAL INSTRUCTION:
${instruction}

COMPLETED TASKS:
${completedTasks.map(t => `- ${t.acceptance}`).join('\n')}

FAILED TASKS:
${failedTasks.map(t => `- ${t.acceptance}`).join('\n')}

Your task:
1. Determine if the original instruction is fully satisfied
2. Identify any missing aspects
3. Suggest additional tasks if needed

Output (JSON):
{
  "isComplete": true/false,
  "missingAspects": ["aspect1", "aspect2"],
  "additionalTaskSuggestions": ["task1", "task2"]
}`;
};
```

#### æ¨å®šå·¥æ•°
4-6æ™‚é–“

---

### 5.8 ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã®ç¶™ç¶šæ€§ ã€å„ªå…ˆåº¦: ä½ã€‘

#### å•é¡Œç‚¹
- ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ãŒå‰å›ã®ã‚„ã‚Šå–ã‚Šã‚’ç¶™ç¶šã§ããªã„
- è¿½åŠ ã‚¿ã‚¹ã‚¯ç”Ÿæˆæ™‚ã«å‰å›ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒå¤±ã‚ã‚Œã‚‹

#### æ”¹å–„å†…å®¹

**5.8.1 ä¼šè©±å±¥æ­´ã®ä¿å­˜**

```typescript
interface PlannerSession {
  sessionId: string;
  instruction: string;
  conversationHistory: { role: string; content: string }[];
  generatedTasks: TaskBreakdown[];
}

const savePlannerSession = async (session: PlannerSession): Promise<void> => {
  await fs.writeFile(
    `${coordRepoPath}/planner-sessions/${session.sessionId}.json`,
    JSON.stringify(session, null, 2)
  );
};
```

**5.8.2 ä¼šè©±å±¥æ­´ã‚’ä½¿ã£ãŸè¿½åŠ ã‚¿ã‚¹ã‚¯ç”Ÿæˆ**

```typescript
const planAdditionalTasks = async (
  sessionId: string,
  missingAspects: string[]
) => {
  const session = await loadPlannerSession(sessionId);

  const prompt = `
Previous conversation:
${session.conversationHistory.map(m => `${m.role}: ${m.content}`).join('\n\n')}

Based on the above context, the following aspects are still missing:
${missingAspects.join('\n')}

Generate additional tasks to address these missing aspects.
`;

  // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‘¼ã³å‡ºã—
  const result = await runClaudeAgent(prompt, ...);

  // ä¼šè©±å±¥æ­´ã‚’æ›´æ–°
  session.conversationHistory.push(
    { role: 'user', content: prompt },
    { role: 'assistant', content: result.val.finalResponse }
  );
  await savePlannerSession(session);

  return parseAgentOutput(result.val.finalResponse);
};
```

#### æ¨å®šå·¥æ•°
4-6æ™‚é–“

---

### 5.9 ãƒ¢ãƒ‡ãƒ«ã®ä½¿ã„åˆ†ã‘ ã€å„ªå…ˆåº¦: ä½ã€‘ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âœ… å®Œäº†ã€‘

**å®Œäº†æ—¥**: 2026-01-19

#### å•é¡Œç‚¹
- ã™ã¹ã¦ã®å½¹å‰²ã§åŒã˜ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹
- ã‚³ã‚¹ãƒˆåŠ¹ç‡ãŒæ‚ªã„

#### æ”¹å–„å†…å®¹

**5.9.1 å½¹å‰²åˆ¥ãƒ¢ãƒ‡ãƒ«å®šç¾©**

```typescript
const MODEL_CONFIG = {
  planner: 'claude-opus-4-5-20251101',    // é«˜åº¦ãªè¨ˆç”»èƒ½åŠ›ãŒå¿…è¦
  worker: 'claude-sonnet-4-5-20250929',   // ãƒãƒ©ãƒ³ã‚¹å‹
  judge: 'claude-haiku-4-5-20250929',     // è»½é‡ã§é«˜é€Ÿ
  qualityCheck: 'claude-haiku-4-5-20250929', // è»½é‡ã§é«˜é€Ÿ
  conflictResolution: 'claude-sonnet-4-5-20250929', // ä¸­ç¨‹åº¦ã®è¤‡é›‘ã•
} as const;
```

**5.9.2 å„æ“ä½œã§ã®é©ç”¨**

```typescript
// Planner
const runResult = await deps.runnerEffects.runClaudeAgent(
  planningPrompt,
  deps.appRepoPath,
  MODEL_CONFIG.planner,  // Opusä½¿ç”¨
);

// Judge
const result = await runnerEffects.runClaudeAgent(
  judgementPrompt,
  appRepoPath,
  MODEL_CONFIG.judge,  // Haikuä½¿ç”¨
);

// Worker
const agentResult = await deps.runnerEffects.runClaudeAgent(
  agentPrompt,
  worktreePath,
  MODEL_CONFIG.worker,  // Sonnetä½¿ç”¨
);
```

#### æ¨å®šå·¥æ•°
2-3æ™‚é–“

#### å®Ÿè£…çµæœ

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**:
- `src/core/config/models.ts` - å½¹å‰²åˆ¥ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¨­å®šï¼ˆæ–°è¦ä½œæˆï¼‰
- `src/core/orchestrator/planner-operations.ts` - Planner ã§ã®ãƒ¢ãƒ‡ãƒ«é©ç”¨
- `src/core/orchestrator/worker-operations.ts` - Worker ã§ã®ãƒ¢ãƒ‡ãƒ«é©ç”¨

**å®Ÿè£…å†…å®¹**:
1. `AGENT_CONFIG` å®šæ•°ã‚’å®šç¾©ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã¨ãƒ¢ãƒ‡ãƒ«ã®ãƒšã‚¢ï¼‰
2. Planner ã§ `AGENT_CONFIG.planner.model` (Opus) ã‚’ä½¿ç”¨
3. Worker ã§ `AGENT_CONFIG.worker.model` (Sonnet) ã‚’ä½¿ç”¨
4. Judge ã¯ Phase 5.6 ã§å¯¾å¿œäºˆå®šï¼ˆç¾åœ¨ã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‘¼ã³å‡ºã—ãªã—ï¼‰

**åŠ¹æœ**:
- Planner ã«é«˜æ€§èƒ½ãª Opus ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ã‚¿ã‚¹ã‚¯åˆ†è§£ã®å“è³ªå‘ä¸Š
- Worker ã« Sonnet ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€å®Ÿè£…ã¨ã‚³ã‚¹ãƒˆã®ãƒãƒ©ãƒ³ã‚¹ã‚’ç¶­æŒ
- Judge ã« Haiku ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€åˆ¤å®šå‡¦ç†ã®é«˜é€ŸåŒ–ã¨ã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼ˆPhase 5.6 å®Ÿè£…æ™‚ï¼‰

---

## æ–°è¦è¦³ç‚¹ã®å®Ÿè£…é †åº

### æ¨å¥¨å®Ÿè£…é †åº

1. **Phase 5.9**: ãƒ¢ãƒ‡ãƒ«ã®ä½¿ã„åˆ†ã‘ï¼ˆ2-3æ™‚é–“ï¼‰
   - å³åº§ã«ã‚³ã‚¹ãƒˆå‰Šæ¸›åŠ¹æœ
   - ä»–ã®ãƒ•ã‚§ãƒ¼ã‚ºã®å®Ÿè£…ã‚³ã‚¹ãƒˆã‚‚ä¸‹ãŒã‚‹

2. **Phase 5.1**: ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã®å“è³ªå‘ä¸Šï¼ˆ4-6æ™‚é–“ï¼‰
   - ã‚¿ã‚¹ã‚¯å“è³ªã®åŸºç›¤æ”¹å–„
   - å¾Œç¶šãƒ•ã‚§ãƒ¼ã‚ºã®åŠ¹æœã‚’é«˜ã‚ã‚‹

3. **Phase 5.2**: ã‚¸ãƒ£ãƒƒã‚¸ã«ã‚ˆã‚‹ã‚¿ã‚¹ã‚¯å“è³ªè©•ä¾¡ï¼ˆ6-8æ™‚é–“ï¼‰
   - ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼æ”¹å–„ã¨ç›¸ä¹—åŠ¹æœ
   - å“è³ªä¿è¨¼ã®åŸºç›¤

4. **Phase 5.3**: ä¸¦åˆ—å®Ÿè¡Œã‚µãƒãƒ¼ãƒˆï¼ˆ8-12æ™‚é–“ï¼‰
   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å¤§å¹…æ”¹å–„
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®å‘ä¸Š

5. **Phase 5.4**: ç›´åˆ—ã‚¿ã‚¹ã‚¯ã®å¤‰æ›´çµ±åˆï¼ˆ6-8æ™‚é–“ï¼‰
   - ä¸¦åˆ—å®Ÿè¡Œã¨çµ„ã¿åˆã‚ã›ã¦çœŸä¾¡ã‚’ç™ºæ®

6. **Phase 5.5**: çµ±åˆå‡¦ç†ã¨ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºï¼ˆ8-10æ™‚é–“ï¼‰
   - ä¸¦åˆ—å®Ÿè¡Œã®å®Œæˆå½¢

7. **Phase 5.6**: ã‚¸ãƒ£ãƒƒã‚¸åˆ¤å®šã®é«˜åº¦åŒ–ï¼ˆ4-6æ™‚é–“ï¼‰
   - å“è³ªä¿è¨¼ã®å®Œæˆ

8. **Phase 5.7**: å…¨ä½“å®Œäº†åˆ¤å®šï¼ˆ4-6æ™‚é–“ï¼‰
   - ã‚·ã‚¹ãƒ†ãƒ ã®è‡ªå¾‹æ€§å‘ä¸Š

9. **Phase 5.8**: ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã®ç¶™ç¶šæ€§ï¼ˆ4-6æ™‚é–“ï¼‰
   - ã‚ˆã‚Šé«˜åº¦ãªä½¿ç”¨ã‚±ãƒ¼ã‚¹ã¸ã®å¯¾å¿œ

### ã‚¯ã‚¤ãƒƒã‚¯ã‚¦ã‚£ãƒ³ï¼ˆå„ªå…ˆå®Ÿè£…ï¼‰

æ™‚é–“ãŒé™ã‚‰ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®é †åºã‚’æ¨å¥¨:

1. **Phase 5.9**: ãƒ¢ãƒ‡ãƒ«ã®ä½¿ã„åˆ†ã‘ï¼ˆ2-3æ™‚é–“ï¼‰
2. **Phase 5.1**: ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã®å“è³ªå‘ä¸Šï¼ˆ4-6æ™‚é–“ï¼‰
3. **Phase 5.2**: ã‚¸ãƒ£ãƒƒã‚¸ã«ã‚ˆã‚‹ã‚¿ã‚¹ã‚¯å“è³ªè©•ä¾¡ï¼ˆ6-8æ™‚é–“ï¼‰

ã“ã‚Œã‚‰ã ã‘ã§ã€ã‚¿ã‚¹ã‚¯å“è³ªãŒå¤§å¹…ã«å‘ä¸Šã—ã€ã‚³ã‚¹ãƒˆã‚‚å‰Šæ¸›ã§ãã‚‹ã€‚

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [current-issues.md](./current-issues.md) - ç¾åœ¨ã®å•é¡Œç‚¹
- [docs/architecture.md](../../docs/architecture.md) - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [README.md](../../README.md) - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆREADME
